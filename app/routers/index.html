{% extends "base.html" %}
{% block title %}Dashboard - FinLAN{% endblock %}
{% block content %}
<div style="padding: 0 8px;">

  <!-- Page Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px;">
    <div>
      <h2 style="margin: 0 0 4px 0;">Dashboard</h2>
      <div style="color: #64748b; font-size: 14px;">Welcome back, <strong>{{ username }}</strong> &nbsp;¬∑&nbsp; <span id="asOfDate">Loading...</span></div>
    </div>
    <button onclick="refreshAll()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">‚ü≥ Refresh</button>
  </div>

  <!-- Net Worth Banner -->
  <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; padding: 28px 32px; border-radius: 16px; margin-bottom: 28px; display: flex; gap: 48px; flex-wrap: wrap; align-items: center;">
    <div>
      <div style="font-size: 13px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px;">Total Net Worth</div>
      <div style="font-size: 42px; font-weight: 700; margin-top: 4px;" id="netWorth">$‚Äî</div>
    </div>
    <div style="display: flex; gap: 40px; flex-wrap: wrap;">
      <div>
        <div style="font-size: 12px; opacity: 0.6;">Portfolio Assets</div>
        <div style="font-size: 22px; font-weight: 600; color: #4ade80;" id="portfolioTotal">$‚Äî</div>
      </div>
      <div>
        <div style="font-size: 12px; opacity: 0.6;">Equity Awards</div>
        <div style="font-size: 22px; font-weight: 600; color: #a78bfa;" id="equityTotal">$‚Äî</div>
      </div>
      <div>
        <div style="font-size: 12px; opacity: 0.6;">Cash &amp; Savings</div>
        <div style="font-size: 22px; font-weight: 600; color: #60a5fa;" id="cashTotal">$‚Äî</div>
      </div>
      <div>
        <div style="font-size: 12px; opacity: 0.6;">Monthly Income</div>
        <div style="font-size: 22px; font-weight: 600; color: #34d399;" id="monthlyIncome">$‚Äî</div>
      </div>
      <div>
        <div style="font-size: 12px; opacity: 0.6;">Monthly Expenses</div>
        <div style="font-size: 22px; font-weight: 600; color: #f87171;" id="monthlyExpenses">$‚Äî</div>
      </div>
      <div>
        <div style="font-size: 12px; opacity: 0.6;">Mortgage Balance</div>
        <div style="font-size: 22px; font-weight: 600; color: #fbbf24;" id="mortgageTotal">$‚Äî</div>
      </div>
    </div>
  </div>

  <!-- Two Column Section -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">

    <!-- Portfolio Summary -->
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0; font-size: 16px; color: #1e293b;">üìà Portfolio</h3>
        <a href="/portfolio" style="font-size: 13px; color: #3b82f6; text-decoration: none;">View all ‚Üí</a>
      </div>
      <div id="portfolioAccountsList" style="font-size: 14px; color: #64748b;">Loading...</div>
    </div>

    <!-- Equity Awards Summary -->
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0; font-size: 16px; color: #1e293b;">üèÜ Equity Awards</h3>
        <a href="/equity-awards" style="font-size: 13px; color: #3b82f6; text-decoration: none;">View all ‚Üí</a>
      </div>
      <div id="equitySummaryList" style="font-size: 14px; color: #64748b;">Loading...</div>
    </div>

  </div>

  <!-- Mortgage Summary -->
  <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 style="margin: 0; font-size: 16px; color: #1e293b;">üè† Mortgage</h3>
      <a href="/mortgage" style="font-size: 13px; color: #3b82f6; text-decoration: none;">Manage ‚Üí</a>
    </div>
    <div id="mortgageSummaryList" style="font-size: 14px; color: #64748b;">Loading...</div>
  </div>

  <!-- Bottom Row: Recent Transactions + Quick Links -->
  <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">

    <!-- Recent Transactions -->
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0; font-size: 16px; color: #1e293b;">üïí Recent Transactions</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
          <button id="syncBtn" onclick="syncNow()" style="background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">‚Üª Sync Now</button>
          <a href="/portfolio" style="font-size: 13px; color: #3b82f6; text-decoration: none;">View in Portfolio ‚Üí</a>
        </div>
      </div>
      <table style="width: 100%; min-width: unset; border-collapse: collapse; font-size: 13px;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 8px 10px; text-align: left; color: #64748b; font-weight: 600; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #e2e8f0;">Date</th>
            <th style="padding: 8px 10px; text-align: left; color: #64748b; font-weight: 600; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #e2e8f0;">Description</th>
            <th style="padding: 8px 10px; text-align: left; color: #64748b; font-weight: 600; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #e2e8f0;">Category</th>
            <th style="padding: 8px 10px; text-align: right; color: #64748b; font-weight: 600; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #e2e8f0;">Amount</th>
          </tr>
        </thead>
        <tbody id="recentTxBody">
          <tr><td colspan="4" style="padding: 20px; text-align: center; color: #94a3b8;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Quick Links -->
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
      <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #1e293b;">‚ö° Quick Links</h3>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <a href="/portfolio" style="display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: #f0fdf4; border-radius: 8px; text-decoration: none; color: #15803d; font-weight: 500; font-size: 14px; border: 1px solid #bbf7d0;">
          üìà Portfolio Holdings
        </a>
        <a href="/portfolio/upload" style="display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: #eff6ff; border-radius: 8px; text-decoration: none; color: #1d4ed8; font-weight: 500; font-size: 14px; border: 1px solid #bfdbfe;">
          üì§ Upload Holdings / ESPP
        </a>
        <a href="/equity-awards" style="display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: #faf5ff; border-radius: 8px; text-decoration: none; color: #7e22ce; font-weight: 500; font-size: 14px; border: 1px solid #e9d5ff;">
          üèÜ Equity Awards
        </a>
        <a href="/receipts" style="display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: #fff7ed; border-radius: 8px; text-decoration: none; color: #c2410c; font-weight: 500; font-size: 14px; border: 1px solid #fed7aa;">
          üßæ HSA Receipts
        </a>
        <a href="/mortgage" style="display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: #fefce8; border-radius: 8px; text-decoration: none; color: #854d0e; font-weight: 500; font-size: 14px; border: 1px solid #fde68a;">
          üè† Mortgage
        </a>
      </div>
    </div>

  </div>
</div>

<script>
function fmt(val) {
  if (!val && val !== 0) return '$‚Äî';
  return '$' + parseFloat(val).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}
function fmtDec(val) {
  if (!val && val !== 0) return '$‚Äî';
  return '$' + parseFloat(val).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtDate(d) {
  if (!d) return '‚Äî';
  // Parse as local date to avoid UTC midnight shifting the day
  const [y, m, day] = String(d).split('T')[0].split('-').map(Number);
  return new Date(y, m - 1, day).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

async function loadPortfolio() {
  try {
    const [summaryRes, accountsRes] = await Promise.all([
      fetch('/portfolio/summary'),
      fetch('/portfolio/accounts')
    ]);
    const summary = await summaryRes.json();
    const accounts = await accountsRes.json();

    let investmentTotal = 0, cashTotal = 0;
    accounts.forEach(a => {
      // Exclude ESPP/RSU tracking accounts (balance = equity value, tracked separately)
      if (a.account_name && (a.account_name.includes('ESPP') || a.account_name.includes('RSU'))) return;
      if (a.account_type === 'checking' || a.account_type === 'savings') {
        cashTotal += parseFloat(a.balance || 0);
      } else {
        investmentTotal += parseFloat(a.balance || 0);
      }
    });

    document.getElementById('portfolioTotal').textContent = fmt(investmentTotal);
    document.getElementById('cashTotal').textContent = fmt(cashTotal);

    const sorted = [...accounts]
      .filter(a => !(a.account_name || '').match(/ESPP|RSU/))
      .sort((a, b) => parseFloat(b.balance || 0) - parseFloat(a.balance || 0))
      .slice(0, 6);

    document.getElementById('portfolioAccountsList').innerHTML = sorted.map(a => `
      <div style="display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid #f1f5f9;">
        <div>
          <div style="font-weight: 500; color: #1e293b;">${a.account_name}</div>
          <div style="font-size: 12px; color: #94a3b8;">${a.institution}</div>
        </div>
        <div style="font-weight: 600; color: #1e293b;">${fmt(a.balance)}</div>
      </div>
    `).join('');

    if (summary.snapshot_date) {
      document.getElementById('asOfDate').textContent = 'As of ' + fmtDate(summary.snapshot_date);
    } else {
      document.getElementById('asOfDate').textContent = 'As of ' + fmtDate(new Date().toISOString().split('T')[0]);
    }
    updateNetWorth();
  } catch(e) {
    document.getElementById('portfolioAccountsList').textContent = 'Error loading portfolio';
  }
}

async function loadEquity() {
  try {
    const [rsuRes, esppRes] = await Promise.all([
      fetch('/portfolio/rsu/grants'),
      fetch('/portfolio/espp/grants')
    ]);
    const rsu = await rsuRes.json();
    const espp = await esppRes.json();

    const rsuSellable = rsu.reduce((s, g) => s + (g.est_market_value || 0), 0);
    const rsuUnvested = rsu.reduce((s, g) => s + (g.unvested_market_value || 0), 0);
    const esppVal = espp.reduce((s, g) => s + (g.est_market_value || 0), 0);
    const totalSellable = rsuSellable + esppVal;
    const totalEquity = rsuSellable + rsuUnvested + esppVal;
    const esppGain = espp.reduce((s, g) => s + (g.expected_gain_loss || 0), 0);

    document.getElementById('equityTotal').textContent = fmt(totalEquity);

    document.getElementById('equitySummaryList').innerHTML = `
      <div style="display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid #f1f5f9;">
        <div style="color: #64748b;">RSU Sellable</div>
        <div style="font-weight: 600; color: #10b981;">${fmt(rsuSellable)}</div>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid #f1f5f9;">
        <div style="color: #64748b;">RSU Unvested</div>
        <div style="font-weight: 600; color: #8b5cf6;">${fmt(rsuUnvested)}</div>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid #f1f5f9;">
        <div style="color: #64748b;">ESPP Value</div>
        <div style="font-weight: 600; color: #f59e0b;">${fmt(esppVal)}</div>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid #f1f5f9;">
        <div style="color: #64748b;">ESPP Gain/Loss</div>
        <div style="font-weight: 600; color: ${esppGain >= 0 ? '#10b981' : '#ef4444'};">${esppGain >= 0 ? '+' : ''}${fmtDec(esppGain)}</div>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 8px 0; margin-top: 4px;">
        <div style="font-weight: 700; color: #1e293b;">Total Sellable</div>
        <div style="font-weight: 700; color: #1e293b;">${fmt(totalSellable)}</div>
      </div>
    `;
    updateNetWorth();
  } catch(e) {
    document.getElementById('equitySummaryList').textContent = 'Error loading equity data';
  }
}

async function loadTransactions() {
  try {
    const res = await fetch('/portfolio/transactions?limit=1000');
    const txs = await res.json();
    const now = new Date();
    const monthTxs = txs.filter(t => {
      const d = new Date(t.date);
      return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });
    const income = monthTxs.filter(t => parseFloat(t.amount) > 0).reduce((s, t) => s + parseFloat(t.amount || 0), 0);
    const expenses = monthTxs.filter(t => parseFloat(t.amount) < 0).reduce((s, t) => s + Math.abs(parseFloat(t.amount || 0)), 0);
    document.getElementById('monthlyIncome').textContent = fmt(income);
    document.getElementById('monthlyExpenses').textContent = fmt(expenses);

    const recent = [...txs].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
    document.getElementById('recentTxBody').innerHTML = recent.length ? recent.map(t => {
      const amt = parseFloat(t.amount);
      const color = amt >= 0 ? '#10b981' : '#ef4444';
      const prefix = amt >= 0 ? '+' : '';
      return `
        <tr onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background=''">
          <td style="padding: 8px 10px; border-bottom: 1px solid #f1f5f9; color: #64748b; white-space: nowrap;">${fmtDate(t.date)}</td>
          <td style="padding: 8px 10px; border-bottom: 1px solid #f1f5f9; color: #1e293b; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${(t.description || '').replace(/"/g,'&quot;')}">${t.description || '‚Äî'}</td>
          <td style="padding: 8px 10px; border-bottom: 1px solid #f1f5f9; color: #64748b;">${t.category || '‚Äî'}</td>
          <td style="padding: 8px 10px; border-bottom: 1px solid #f1f5f9; text-align: right; font-weight: 600; color: ${color};">${prefix}${fmtDec(Math.abs(amt))}</td>
        </tr>`;
    }).join('') : '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #94a3b8;">No transactions found</td></tr>';
  } catch(e) {
    document.getElementById('recentTxBody').innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #94a3b8;">Error loading transactions</td></tr>';
  }
}

async function syncNow() {
  const btn = document.getElementById('syncBtn');
  btn.textContent = '‚è≥ Syncing...';
  btn.disabled = true;
  btn.style.background = '#fef9c3';
  btn.style.color = '#92400e';
  btn.style.borderColor = '#fde68a';
  try {
    const res = await fetch('/portfolio/plaid/sync/all', { method: 'POST' });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
    const errors = (data.results || []).filter(r => r.error);
    const ok = (data.results || []).filter(r => !r.error);
    if (errors.length > 0) {
      const msg = errors.map(r => `‚Ä¢ ${r.institution}: ${r.error}`).join('\n');
      const okMsg = ok.length ? `\n\nSucceeded:\n` + ok.map(r => `‚Ä¢ ${r.institution}: ${r.accounts} accounts, ${r.transactions} new tx`).join('\n') : '';
      alert(`Sync completed with ${errors.length} error(s):\n${msg}${okMsg}`);
      btn.textContent = `‚ö† ${errors.length} error(s)`;
      btn.style.background = '#fffbeb'; btn.style.color = '#92400e'; btn.style.borderColor = '#fde68a';
    } else {
      const txTotal = (data.results || []).reduce((s, r) => s + (r.transactions || 0), 0);
      btn.textContent = `‚úì ${txTotal} new tx`;
      btn.style.background = '#f0fdf4'; btn.style.color = '#16a34a'; btn.style.borderColor = '#bbf7d0';
    }
    await loadTransactions();
    setTimeout(() => { btn.textContent = '‚Üª Sync Now'; btn.disabled = false; btn.style.background='#f0fdf4'; btn.style.color='#16a34a'; btn.style.borderColor='#bbf7d0'; }, 5000);
  } catch(e) {
    alert('Sync failed: ' + e.message);
    btn.textContent = '‚úó Failed';
    btn.style.background = '#fef2f2';
    btn.style.color = '#dc2626';
    btn.style.borderColor = '#fecaca';
    setTimeout(() => { btn.textContent = '‚Üª Sync Now'; btn.disabled = false; btn.style.background='#f0fdf4'; btn.style.color='#16a34a'; btn.style.borderColor='#bbf7d0'; }, 5000);
  }
}

async function loadMortgage() {
  try {
    const res = await fetch('/mortgage/summary');
    const data = await res.json();
    if (!data.length) {
      document.getElementById('mortgageSummaryList').innerHTML = '<span style="color:#94a3b8">No mortgage accounts. <a href="/mortgage" style="color:#3b82f6">Add one ‚Üí</a></span>';
      document.getElementById('mortgageTotal').textContent = '$0';
      updateNetWorth();
      return;
    }
    const totalBalance = data.reduce((s, m) => s + (m.current_balance || 0), 0);
    document.getElementById('mortgageTotal').textContent = fmt(totalBalance);

    document.getElementById('mortgageSummaryList').innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;">
        ${data.map(m => `
          <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px 14px;">
            <div style="font-weight:600;color:#1e293b;margin-bottom:4px;">${m.servicer_name}
              ${m.interest_rate ? `<span style="font-size:11px;background:#dbeafe;color:#1d4ed8;border-radius:999px;padding:1px 7px;margin-left:6px;">${m.interest_rate.toFixed(3)}%</span>` : ''}
            </div>
            ${m.property_address ? `<div style="font-size:11px;color:#94a3b8;margin-bottom:6px;">${m.property_address}</div>` : ''}
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f1f5f9;">
              <span style="color:#64748b;">Balance</span>
              <span style="font-weight:700;color:#ef4444;">${m.current_balance ? fmt(m.current_balance) : '‚Äî'}</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f1f5f9;">
              <span style="color:#64748b;">Next Payment</span>
              <span style="font-weight:600;">${m.payment_amount ? fmtDec(m.payment_amount) : '‚Äî'} ${m.due_date ? '<span style="color:#94a3b8;font-size:11px;">due '+fmtDate(m.due_date)+'</span>' : ''}</span>
            </div>
            ${m.principal_portion ? `
            <div style="display:flex;gap:6px;margin-top:6px;font-size:11px;">
              <span style="background:#dcfce7;color:#15803d;border-radius:4px;padding:2px 6px;">P ${fmtDec(m.principal_portion)}</span>
              <span style="background:#fee2e2;color:#b91c1c;border-radius:4px;padding:2px 6px;">I ${fmtDec(m.interest_portion)}</span>
              ${m.escrow_portion ? `<span style="background:#fef9c3;color:#854d0e;border-radius:4px;padding:2px 6px;">Esc ${fmtDec(m.escrow_portion)}</span>` : ''}
            </div>` : ''}
            ${m.ytd_interest ? `<div style="font-size:11px;color:#94a3b8;margin-top:5px;">YTD Interest: ${fmtDec(m.ytd_interest)}</div>` : ''}
          </div>
        `).join('')}
      </div>
    `;
    updateNetWorth();
  } catch(e) {
    document.getElementById('mortgageSummaryList').textContent = 'Error loading mortgage data';
  }
}

function updateNetWorth() {
  const toNum = s => parseFloat((s || '').replace(/[$,‚Äî]/g, '')) || 0;
  const portfolio = toNum(document.getElementById('portfolioTotal').textContent);
  const cash = toNum(document.getElementById('cashTotal').textContent);
  const equity = toNum(document.getElementById('equityTotal').textContent);
  const mortgage = toNum(document.getElementById('mortgageTotal').textContent);
  const total = portfolio + cash + equity - mortgage;
  if (total !== 0) document.getElementById('netWorth').textContent = fmt(total);
}

async function refreshAll() {
  document.getElementById('netWorth').textContent = '$‚Äî';
  await Promise.all([loadPortfolio(), loadEquity(), loadTransactions(), loadMortgage()]);
}

refreshAll();
</script>
{% endblock %}
