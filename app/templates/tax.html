{% extends "base.html" %}
{% block content %}

<style>
  /* ‚îÄ‚îÄ Year tabs ‚îÄ‚îÄ */
  .tax-year-tabs { display:flex; gap:0.45rem; flex-wrap:wrap; margin:0.5rem 0 1.5rem; }
  .tax-year-tab  { padding:0.3rem 0.85rem; border-radius:999px; border:1px solid #cbd5e1;
                   background:#fff; color:#475569; text-decoration:none; font-size:0.87rem;
                   font-weight:500; transition:all .15s; }
  .tax-year-tab:hover  { background:#f1f5f9; border-color:#94a3b8; }
  .tax-year-tab.active { background:#1e40af; color:#fff; border-color:#1e40af; }

  /* ‚îÄ‚îÄ Summary cards ‚îÄ‚îÄ */
  .summary-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(155px, 1fr));
                  gap:1rem; margin-bottom:1.5rem; }
  .summary-card { background:#fff; border:1px solid #e2e8f0; border-radius:10px;
                  padding:1rem 1.2rem; }
  .summary-card h4 { font-size:0.73rem; color:#64748b; margin-bottom:0.25rem; font-weight:500;
                     text-transform:uppercase; letter-spacing:.05em; }
  .summary-card .s-val { font-size:1.3rem; font-weight:700; color:#1e3a8a; }
  .summary-card .s-sub { font-size:0.73rem; color:#94a3b8; margin-top:0.1rem; }

  /* ‚îÄ‚îÄ Form type badges ‚îÄ‚îÄ */
  .form-badge { display:inline-block; border-radius:5px; padding:0.15rem 0.55rem;
                font-size:0.77rem; font-weight:700; letter-spacing:.03em; white-space:nowrap; }
  .form-w2                { background:#dbeafe; color:#1d4ed8; }
  .form-1099_int          { background:#d1fae5; color:#065f46; }
  .form-1098_t            { background:#fef3c7; color:#92400e; }
  .form-1098              { background:#ede9fe; color:#5b21b6; }
  .form-3922              { background:#ccfbf1; color:#0f766e; }
  .form-1099_consolidated { background:#e0e7ff; color:#3730a3; }
  .form-1099_r            { background:#fce7f3; color:#9d174d; }
  .form-ssa_1099          { background:#fff7ed; color:#9a3412; }
  .form-1099_sa           { background:#f0fdf4; color:#166534; }

  /* ‚îÄ‚îÄ Status pills ‚îÄ‚îÄ */
  .status-pill          { display:inline-block; border-radius:999px; padding:0.15rem 0.65rem;
                          font-size:0.77rem; font-weight:600; }
  .status-pill.uploaded { background:#dbeafe; color:#1d4ed8; }
  .status-pill.filed    { background:#d1fae5; color:#065f46; }
  .status-pill.expected { background:#fef9c3; color:#854d0e; }

  /* ‚îÄ‚îÄ Document table ‚îÄ‚îÄ */
  .doc-section { background:#fff; border:1px solid #e2e8f0; border-radius:10px;
                 padding:1.5rem; margin-bottom:1.5rem; }
  table { width:100%; border-collapse:collapse; font-size:0.875rem; }
  th { background:#f8fafc; padding:0.6rem 0.75rem; text-align:left; color:#475569;
       font-weight:600; font-size:0.78rem; text-transform:uppercase; letter-spacing:.04em;
       border-bottom:1px solid #e2e8f0; }
  td { padding:0.65rem 0.75rem; border-bottom:1px solid #f1f5f9; color:#334155;
       vertical-align:middle; }
  tr.doc-row:last-of-type td { border-bottom:none; }
  tr.doc-row:hover td { background:#f8fafc; }
  tr.detail-row td { background:#f8fafc; border-bottom:1px solid #e2e8f0; padding:0; }

  /* ‚îÄ‚îÄ Expandable detail grid ‚îÄ‚îÄ */
  .detail-inner { padding:0.75rem 1rem; }
  .detail-grid  { display:grid; grid-template-columns:repeat(auto-fill, minmax(210px, 1fr));
                  gap:0.4rem 1.5rem; }
  .d-label { font-size:0.72rem; color:#94a3b8; text-transform:uppercase; letter-spacing:.05em; }
  .d-val   { font-size:0.88rem; color:#1e293b; font-weight:500; }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .btn         { padding:0.35rem 0.8rem; border-radius:6px; border:none; cursor:pointer;
                 font-size:0.81rem; font-weight:500; transition:all .15s; }
  .btn-primary { background:#2563eb; color:#fff; }
  .btn-primary:hover { background:#1d4ed8; }
  .btn-ghost   { background:transparent; color:#64748b; border:1px solid #e2e8f0; }
  .btn-ghost:hover { background:#f1f5f9; color:#334155; }
  .btn-danger  { background:#fee2e2; color:#dc2626; border:none; }
  .btn-danger:hover { background:#fecaca; }

  /* ‚îÄ‚îÄ Inline status select ‚îÄ‚îÄ */
  .status-select { border:none; background:transparent; cursor:pointer; font-size:0.82rem;
                   font-weight:600; padding:0.15rem 0.3rem; border-radius:4px; }
  .status-select:focus { outline:1px solid #bfdbfe; }

  /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45);
                   z-index:100; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal-box { background:#fff; border-radius:12px; padding:2rem; width:100%; max-width:600px;
               max-height:92vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,.25); }
  .modal-box h2 { font-size:1.15rem; font-weight:700; color:#1e293b; margin-bottom:1.25rem; }

  /* ‚îÄ‚îÄ Form layout ‚îÄ‚îÄ */
  .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.7rem; }
  .form-group { display:flex; flex-direction:column; gap:0.2rem; }
  .form-group.span2 { grid-column:span 2; }
  .form-group label { font-size:0.81rem; color:#475569; font-weight:500; }
  .form-group input[type=text],
  .form-group input[type=number],
  .form-group input[type=date],
  .form-group select,
  .form-group textarea,
  .form-group input[type=file] {
    padding:0.42rem 0.6rem; border:1px solid #cbd5e1; border-radius:6px;
    font-size:0.87rem; width:100%; box-sizing:border-box; font-family:inherit; }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline:none; border-color:#2563eb; box-shadow:0 0 0 2px #bfdbfe; }
  .form-group textarea { resize:vertical; min-height:58px; }
  .form-group input[type=file] { padding:0.3rem 0.4rem; }

  .field-section { border-top:1px solid #e2e8f0; margin-top:1rem; padding-top:0.85rem; }
  .field-section h3 { font-size:0.8rem; text-transform:uppercase; letter-spacing:.05em;
                      color:#64748b; margin-bottom:0.75rem; font-weight:600; }

  .modal-actions { display:flex; justify-content:flex-end; gap:0.75rem; margin-top:1.25rem;
                   padding-top:1rem; border-top:1px solid #e2e8f0; }

  /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
  .empty-state     { text-align:center; padding:3rem 1rem; color:#94a3b8; }
  .empty-state p   { font-size:1rem; margin-bottom:0.5rem; }
  .empty-state .hint { font-size:0.87rem; }

  @media(max-width:640px) {
    .summary-grid { grid-template-columns:1fr 1fr; }
    .form-grid { grid-template-columns:1fr; }
    .form-group.span2 { grid-column:span 1; }
  }
  /* ‚îÄ‚îÄ Scan ‚îÄ‚îÄ */
  .scan-spinner { display:inline-block; width:12px; height:12px; border:2px solid #bfdbfe;
                  border-top-color:#2563eb; border-radius:50%; animation:spin .7s linear infinite;
                  vertical-align:middle; margin-right:4px; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .scan-toast { position:fixed; bottom:1.5rem; right:1.5rem; z-index:200;
                background:#1e293b; color:#f8fafc; border-radius:8px;
                padding:0.7rem 1.1rem; font-size:0.87rem; box-shadow:0 8px 24px rgba(0,0,0,.3);
                transition:opacity .3s; max-width:340px; }
  .scan-toast.hidden { opacity:0; pointer-events:none; }
  .scan-field-hit  { background:#fef9c3 !important; }
  .scan-field-miss { /* no fill, leave as-is */ }
  @media print {
    .no-print { display:none !important; }
    .modal-overlay { display:none !important; }
    body { background:#fff !important; }
    .summary-grid { grid-template-columns:repeat(4,1fr) !important; }
  }
</style>

<div style="max-width:1100px;margin:0 auto;padding:1.5rem 1rem;">

  {% if dup_id %}
  <div class="no-print" style="background:#fef3c7;border:1px solid #fbbf24;border-radius:8px;
              padding:0.75rem 1rem;margin-bottom:1rem;color:#92400e;font-size:0.87rem;">
    ‚ö†Ô∏è A <strong>{{ year }}</strong> document with the same form type and issuer already exists.
    Use <strong>Edit</strong> on the existing entry, or change the issuer to add a new one.
  </div>
  {% endif %}

  <!-- ‚îÄ‚îÄ Page Header ‚îÄ‚îÄ -->
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.75rem;">
    <div>
      <h1 style="font-size:1.5rem;font-weight:700;color:#1e293b;margin-bottom:0.5rem;">Tax Documents</h1>
      <div class="tax-year-tabs">
        {% for y in year_options %}
        <a href="/tax?year={{ y }}" class="tax-year-tab {% if y == year %}active{% endif %}">{{ y }}</a>
        {% endfor %}
      </div>
    </div>
    <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;margin-top:0.3rem;">
      {% if not docs and (year - 1) in available_years %}
      <form method="post" action="/tax/seed_year" style="margin:0;">
        <input type="hidden" name="from_year" value="{{ year - 1 }}">
        <input type="hidden" name="to_year" value="{{ year }}">
        <button type="submit" class="btn btn-ghost no-print"
                onclick="return confirm('Seed {{ year }} with Expected placeholders copied from {{ year - 1 }}?')">
          üìã Seed from {{ year - 1 }}
        </button>
      </form>
      {% endif %}
      <button class="btn btn-ghost no-print" onclick="window.print()" title="Print tax summary">üñ®Ô∏è Print</button>
      <button class="btn btn-primary no-print" onclick="openAddModal()">+ Add Document</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Summary Cards ‚îÄ‚îÄ -->
  {% set s = summary %}
  {% if docs and (s.total_wages > 0 or s.total_federal_withheld > 0 or s.total_interest > 0
      or s.total_dividends > 0 or s.net_cap_gain != 0 or s.mortgage_interest > 0
      or s.tuition_paid > 0 or s.total_retirement_dist > 0 or s.total_ss_benefits > 0
      or s.espp_compensation > 0) %}
  <div class="summary-grid">
    {% if s.total_wages > 0 %}
    <div class="summary-card">
      <h4>Total Wages</h4>
      <div class="s-val">${{ "{:,.0f}".format(s.total_wages) }}</div>
      <div class="s-sub">W-2</div>
    </div>
    {% endif %}
    {% if s.total_federal_withheld > 0 %}
    <div class="summary-card">
      <h4>Fed Withheld</h4>
      <div class="s-val">${{ "{:,.0f}".format(s.total_federal_withheld) }}</div>
      <div class="s-sub">All forms</div>
    </div>
    {% endif %}
    {% if s.total_state_withheld > 0 %}
    <div class="summary-card">
      <h4>State Withheld</h4>
      <div class="s-val">${{ "{:,.0f}".format(s.total_state_withheld) }}</div>
      <div class="s-sub">W-2</div>
    </div>
    {% endif %}
    {% if s.total_interest > 0 %}
    <div class="summary-card">
      <h4>Interest Income</h4>
      <div class="s-val">${{ "{:,.2f}".format(s.total_interest) }}</div>
      <div class="s-sub">1099-INT / Consolidated</div>
    </div>
    {% endif %}
    {% if s.total_dividends > 0 %}
    <div class="summary-card">
      <h4>Ordinary Dividends</h4>
      <div class="s-val">${{ "{:,.2f}".format(s.total_dividends) }}</div>
      <div class="s-sub">1099-DIV (1099-C)</div>
    </div>
    {% endif %}
    {% if s.total_qualified_div > 0 %}
    <div class="summary-card">
      <h4>Qualified Div</h4>
      <div class="s-val">${{ "{:,.2f}".format(s.total_qualified_div) }}</div>
      <div class="s-sub">Box 1b</div>
    </div>
    {% endif %}
    {% if s.net_cap_gain != 0 %}
    <div class="summary-card">
      <h4>Net Cap Gain/Loss</h4>
      <div class="s-val" style="color:{% if s.net_cap_gain >= 0 %}#166534{% else %}#dc2626{% endif %};">
        {% if s.net_cap_gain >= 0 %}+{% endif %}${{ "{:,.2f}".format(s.net_cap_gain) }}
      </div>
      <div class="s-sub">1099-B</div>
    </div>
    {% endif %}
    {% if s.mortgage_interest > 0 %}
    <div class="summary-card">
      <h4>Mortgage Interest</h4>
      <div class="s-val">${{ "{:,.2f}".format(s.mortgage_interest) }}</div>
      <div class="s-sub">1098</div>
    </div>
    {% endif %}
    {% if s.tuition_paid > 0 %}
    <div class="summary-card">
      <h4>Tuition Paid</h4>
      <div class="s-val">${{ "{:,.2f}".format(s.tuition_paid) }}</div>
      <div class="s-sub">1098-T</div>
    </div>
    {% endif %}
    {% if s.total_retirement_dist > 0 %}
    <div class="summary-card">
      <h4>Retirement Dist</h4>
      <div class="s-val">${{ "{:,.0f}".format(s.total_retirement_dist) }}</div>
      <div class="s-sub">1099-R</div>
    </div>
    {% endif %}
    {% if s.total_ss_benefits > 0 %}
    <div class="summary-card">
      <h4>SS Benefits</h4>
      <div class="s-val">${{ "{:,.0f}".format(s.total_ss_benefits) }}</div>
      <div class="s-sub">SSA-1099</div>
    </div>
    {% endif %}
    {% if s.espp_compensation > 0 %}
    <div class="summary-card">
      <h4>ESPP Comp Element</h4>
      <div class="s-val">${{ "{:,.2f}".format(s.espp_compensation) }}</div>
      <div class="s-sub">Form 3922</div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- ‚îÄ‚îÄ Document Table ‚îÄ‚îÄ -->
  <div class="doc-section">
    {% if docs %}
    <table>
      <thead>
        <tr>
          <th>Form</th>
          <th>Issuer / Description</th>
          <th>Key Figure</th>
          <th>Status</th>
          <th>File</th>
          <th style="width:140px;"></th>
        </tr>
      </thead>
      <tbody>
        {% for item in docs %}
        {% set d = item.doc %}
        <tr class="doc-row" id="row-{{ d.id }}">
          <td>
            <span class="form-badge form-{{ d.form_type|lower }}">
              {{ form_type_display.get(d.form_type, d.form_type) }}
            </span>
          </td>
          <td>
            <div style="font-weight:500;">{{ d.issuer or '‚Äî' }}</div>
            {% if d.description %}
            <div style="font-size:0.78rem;color:#94a3b8;margin-top:0.1rem;">{{ d.description }}</div>
            {% endif %}
          </td>
          <td>
            {% if item.kf_label %}
            <div style="font-size:0.75rem;color:#94a3b8;">{{ item.kf_label }}</div>
            <div style="font-weight:600;color:#1e293b;">{{ item.kf_value }}</div>
            {% else %}
            <span style="color:#cbd5e1;">‚Äî</span>
            {% endif %}
          </td>
          <td>
            <select class="status-select"
                    onchange="updateStatus({{ d.id }}, this.value)">
              <option value="expected" {% if d.status == 'expected' %}selected{% endif %}>‚è≥ Expected</option>
              <option value="uploaded" {% if d.status == 'uploaded' %}selected{% endif %}>üì• Uploaded</option>
              <option value="filed"    {% if d.status == 'filed'    %}selected{% endif %}>‚úÖ Filed</option>
            </select>
          </td>
          <td>
            {% if d.file_name %}
            <button onclick="openPreview({{ d.id }})"
                    class="btn btn-ghost"
                    style="padding:0.2rem 0.5rem;font-size:0.82rem;color:#2563eb;"
                    title="{{ d.original_name }}">üìÑ View</button>
            {% else %}
            <span style="color:#cbd5e1;font-size:0.82rem;">‚Äî</span>
            {% endif %}
          </td>
          <td style="white-space:nowrap;">
            <button id="btn-detail-{{ d.id }}" class="btn btn-ghost"
                    style="padding:0.25rem 0.5rem;font-size:0.77rem;margin-right:0.2rem;"
                    onclick="toggleDetail({{ d.id }})">‚ñ∏</button>
            {% if d.file_name %}
            <button class="btn btn-ghost" id="scan-btn-{{ d.id }}"
                    style="padding:0.25rem 0.55rem;font-size:0.77rem;margin-right:0.2rem;color:#0f766e;"
                    onclick="scanDocument({{ d.id }})" title="OCR scan &amp; auto-fill fields">üîç Scan</button>
            {% endif %}
            <button class="btn btn-ghost"
                    style="padding:0.25rem 0.55rem;font-size:0.77rem;margin-right:0.2rem;"
                    onclick="openEditModal({{ d.id }})">Edit</button>
            <form method="post" action="/tax/{{ d.id }}/delete" style="display:inline;"
                  onsubmit="return confirm('Delete this document and its file?')">
              <input type="hidden" name="tax_year" value="{{ d.tax_year }}">
              <button type="submit" class="btn btn-danger"
                      style="padding:0.25rem 0.55rem;font-size:0.77rem;">‚úï</button>
            </form>
          </td>
        </tr>

        <!-- Expandable detail row -->
        <tr class="detail-row" id="detail-{{ d.id }}" style="display:none;">
          <td colspan="6">
            <div class="detail-inner">
              {% if item.ed %}
              <div class="detail-grid">
                {% for k, v in item.ed.items() %}
                <div>
                  <div class="d-label">{{ k|replace('_', ' ')|title }}</div>
                  <div class="d-val">{{ v }}</div>
                </div>
                {% endfor %}
              </div>
              {% endif %}
              {% if d.notes %}
              <div style="margin-top:0.75rem;padding-top:0.6rem;border-top:1px solid #e2e8f0;
                          font-size:0.85rem;color:#475569;">
                <strong style="color:#64748b;">Notes:</strong> {{ d.notes }}
              </div>
              {% endif %}
              {% if not item.ed and not d.notes %}
              <p style="color:#94a3b8;font-size:0.85rem;margin:0;">
                No structured data entered. Click <strong>Edit</strong> to add key figures.
              </p>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% else %}
    <div class="empty-state">
      <p>üìÇ No tax documents for {{ year }}</p>
      <p class="hint">Click <strong>+ Add Document</strong> to upload and track your tax forms.</p>
      {% if (year - 1) in available_years %}
      <form method="post" action="/tax/seed_year" style="margin-top:1rem;">
        <input type="hidden" name="from_year" value="{{ year - 1 }}">
        <input type="hidden" name="to_year" value="{{ year }}">
        <button type="submit" class="btn btn-ghost no-print">
          üìã Seed Expected Docs from {{ year - 1 }}
        </button>
      </form>
      {% endif %}
    </div>
    {% endif %}
  </div>

</div><!-- /container -->

<!-- ‚ïê‚ïê Add / Edit Modal ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="taxModal" class="modal-overlay">
  <div class="modal-box">
    <h2 id="modalTitle">Add Tax Document</h2>

    <form id="taxForm" method="post" action="/tax/add" enctype="multipart/form-data">

      <!-- Common top fields -->
      <div class="form-grid">
        <div class="form-group">
          <label>Tax Year *</label>
          <input type="number" id="f_tax_year" name="tax_year"
                 value="{{ year }}" min="2015" max="2035" required>
        </div>
        <div class="form-group">
          <label>Form Type *</label>
          <select id="f_form_type" name="form_type" required onchange="onFormTypeChange(this.value)">
            {% for key, label in form_types %}
            <option value="{{ key }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group span2">
          <label>Issuer / From</label>
          <input type="text" id="f_issuer" name="issuer"
                 placeholder="e.g., Microsoft Corp, Fidelity, Chase Bank, University Name">
        </div>
        <div class="form-group span2">
          <label>Description <span style="color:#94a3b8;font-weight:400;">(optional)</span></label>
          <input type="text" id="f_description" name="description"
                 placeholder="e.g., Primary employment, Brokerage account XXXX">
        </div>
      </div>

      <!-- ‚îÄ‚îÄ W-2 ‚îÄ‚îÄ -->
      <div id="fields-W2" class="field-section" style="display:none;">
        <h3>W-2 Details</h3>
        <div class="form-grid">
          <div class="form-group"><label>Employer EIN</label>
            <input type="text" name="ed_employer_ein" placeholder="XX-XXXXXXX"></div>
          <div class="form-group"><label>Box 1 ‚Äì Wages</label>
            <input type="number" name="ed_wages" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 2 ‚Äì Fed Withheld</label>
            <input type="number" name="ed_federal_withheld" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 3 ‚Äì SS Wages</label>
            <input type="number" name="ed_ss_wages" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 4 ‚Äì SS Withheld</label>
            <input type="number" name="ed_ss_withheld" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 5 ‚Äì Medicare Wages</label>
            <input type="number" name="ed_medicare_wages" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 6 ‚Äì Medicare Withheld</label>
            <input type="number" name="ed_medicare_withheld" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>State</label>
            <input type="text" name="ed_state" placeholder="CA" maxlength="2"></div>
          <div class="form-group"><label>State Wages</label>
            <input type="number" name="ed_state_wages" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>State Withheld</label>
            <input type="number" name="ed_state_withheld" step="0.01" placeholder="0.00"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ 1099-INT ‚îÄ‚îÄ -->
      <div id="fields-1099_INT" class="field-section" style="display:none;">
        <h3>1099-INT Details</h3>
        <div class="form-grid">
          <div class="form-group"><label>Box 1 ‚Äì Interest Income</label>
            <input type="number" name="ed_interest_income" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 2 ‚Äì Early Withdrawal Penalty</label>
            <input type="number" name="ed_early_withdrawal_penalty" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 3 ‚Äì US Bond Interest</label>
            <input type="number" name="ed_us_bond_interest" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 4 ‚Äì Fed Withheld</label>
            <input type="number" name="ed_federal_withheld" step="0.01" placeholder="0.00"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ 1098-T ‚îÄ‚îÄ -->
      <div id="fields-1098_T" class="field-section" style="display:none;">
        <h3>1098-T Tuition Details</h3>
        <div class="form-grid">
          <div class="form-group span2"><label>Student Name</label>
            <input type="text" name="ed_student_name" placeholder="Full name as on form"></div>
          <div class="form-group"><label>Box 1 ‚Äì Tuition Paid</label>
            <input type="number" name="ed_tuition_paid" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 5 ‚Äì Scholarships / Grants</label>
            <input type="number" name="ed_scholarships" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 4 ‚Äì Adjustments</label>
            <input type="number" name="ed_adjustments" step="0.01" placeholder="0.00"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ 1098 ‚îÄ‚îÄ -->
      <div id="fields-1098" class="field-section" style="display:none;">
        <h3>1098 Mortgage Interest Details</h3>
        <div class="form-grid">
          <div class="form-group"><label>Box 1 ‚Äì Mortgage Interest Received</label>
            <input type="number" name="ed_mortgage_interest" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 2 ‚Äì Outstanding Mortgage Principal</label>
            <input type="number" name="ed_outstanding_principal" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 3 ‚Äì Mortgage Origination Date</label>
            <input type="date" name="ed_origination_date"></div>
          <div class="form-group"><label>Box 4 ‚Äì Refund of Overpaid Interest</label>
            <input type="number" name="ed_refund_overpaid_interest" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 5 ‚Äì Mortgage Insurance (PMI)</label>
            <input type="number" name="ed_mortgage_insurance" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 6 ‚Äì Points Paid</label>
            <input type="number" name="ed_points" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 9 ‚Äì Number of Properties</label>
            <input type="number" name="ed_num_properties" step="1" placeholder="1" min="1"></div>
          <div class="form-group"><label>Box 10 ‚Äì Other</label>
            <input type="number" name="ed_other" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 11 ‚Äì Mortgage Acquisition Date</label>
            <input type="date" name="ed_acquisition_date"></div>
          <div class="form-group"><label>Lender TIN / EIN</label>
            <input type="text" name="ed_lender_tin" placeholder="XX-XXXXXXX"></div>
          <div class="form-group"><label>Account Number</label>
            <input type="text" name="ed_account_number" placeholder="Account # on form"></div>
          <div class="form-group span2"><label>Box 8 ‚Äì Property Address</label>
            <input type="text" name="ed_property_address" placeholder="Address securing the mortgage"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ 3922 ‚îÄ‚îÄ -->
      <div id="fields-3922" class="field-section" style="display:none;">
        <h3>Form 3922 ‚Äì ESPP Transfer Details</h3>
        <div class="form-grid">
          <div class="form-group span2"><label>Company / Employer</label>
            <input type="text" name="ed_company_name" placeholder=""></div>
          <div class="form-group"><label>Box 1 ‚Äì Grant Date</label>
            <input type="date" name="ed_grant_date"></div>
          <div class="form-group"><label>Box 2 ‚Äì Exercise / Purchase Date</label>
            <input type="date" name="ed_exercise_date"></div>
          <div class="form-group"><label>Box 3 ‚Äì FMV on Grant Date</label>
            <input type="number" name="ed_fmv_on_grant_date" step="0.0001" placeholder="0.0000"></div>
          <div class="form-group"><label>Box 4 ‚Äì FMV on Exercise Date</label>
            <input type="number" name="ed_fmv_on_exercise_date" step="0.0001" placeholder="0.0000"></div>
          <div class="form-group"><label>Box 5 ‚Äì Exercise Price</label>
            <input type="number" name="ed_exercise_price" step="0.0001" placeholder="0.0000"></div>
          <div class="form-group"><label>Box 6 ‚Äì Shares Transferred</label>
            <input type="number" name="ed_shares_transferred" step="0.000001" placeholder="0.000000"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ 1099 Consolidated ‚îÄ‚îÄ -->
      <div id="fields-1099_CONSOLIDATED" class="field-section" style="display:none;">
        <h3>1099 Consolidated Details</h3>
        <div class="form-grid">
          <div class="form-group"><label>Account Last 4 Digits</label>
            <input type="text" name="ed_account_last4" placeholder="XXXX" maxlength="4"></div>
          <div class="form-group"><label>1099-DIV Box 1a ‚Äì Ordinary Dividends</label>
            <input type="number" name="ed_ordinary_dividends" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>1099-DIV Box 1b ‚Äì Qualified Dividends</label>
            <input type="number" name="ed_qualified_dividends" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>1099-DIV Box 2a ‚Äì Total Cap Gain Dist</label>
            <input type="number" name="ed_total_cap_gain_dist" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>1099-INT Box 1 ‚Äì Interest Income</label>
            <input type="number" name="ed_interest_income" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>1099-B ‚Äì Gross Proceeds</label>
            <input type="number" name="ed_gross_proceeds" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>1099-B ‚Äì Cost Basis</label>
            <input type="number" name="ed_cost_basis" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>1099-B ‚Äì Net Gain / Loss</label>
            <input type="number" name="ed_net_gain_loss" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Federal Tax Withheld</label>
            <input type="number" name="ed_federal_withheld" step="0.01" placeholder="0.00"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ 1099-R ‚îÄ‚îÄ -->
      <div id="fields-1099_R" class="field-section" style="display:none;">
        <h3>1099-R Retirement Distribution Details</h3>
        <div class="form-grid">
          <div class="form-group span2"><label>Payer Name</label>
            <input type="text" name="ed_payer_name" placeholder="e.g., Fidelity, Vanguard, 401(k) Plan"></div>
          <div class="form-group"><label>Box 1 ‚Äì Gross Distribution</label>
            <input type="number" name="ed_gross_distribution" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 2a ‚Äì Taxable Amount</label>
            <input type="number" name="ed_taxable_amount" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 4 ‚Äì Fed Withheld</label>
            <input type="number" name="ed_federal_withheld" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 7 ‚Äì Distribution Code</label>
            <input type="text" name="ed_distribution_code" placeholder="e.g., 7, 1, G" maxlength="2"></div>
          <div class="form-group"><label>State</label>
            <input type="text" name="ed_state" placeholder="CA" maxlength="2"></div>
          <div class="form-group"><label>State Tax Withheld</label>
            <input type="number" name="ed_state_withheld" step="0.01" placeholder="0.00"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ SSA-1099 ‚îÄ‚îÄ -->
      <div id="fields-SSA_1099" class="field-section" style="display:none;">
        <h3>SSA-1099 Social Security Benefit Details</h3>
        <div class="form-grid">
          <div class="form-group"><label>Box 3 ‚Äì Gross Benefits</label>
            <input type="number" name="ed_gross_benefits" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 4 ‚Äì Repaid Benefits</label>
            <input type="number" name="ed_repaid_benefits" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 5 ‚Äì Net Benefits</label>
            <input type="number" name="ed_net_benefits" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Medicare Deducted</label>
            <input type="number" name="ed_medicare_deducted" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Voluntary Fed Withheld</label>
            <input type="number" name="ed_voluntary_federal_withheld" step="0.01" placeholder="0.00"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ 1099-SA ‚îÄ‚îÄ -->
      <div id="fields-1099_SA" class="field-section" style="display:none;">
        <h3>1099-SA HSA Distribution Details</h3>
        <div class="form-grid">
          <div class="form-group"><label>Box 1 ‚Äì Total Distributions</label>
            <input type="number" name="ed_total_distributions" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 2 ‚Äì Earnings on Excess</label>
            <input type="number" name="ed_earnings_on_excess" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label>Box 3 ‚Äì Distribution Code</label>
            <input type="text" name="ed_distribution_code" placeholder="1 = Normal" maxlength="2"></div>
          <div class="form-group"><label>Box 5 ‚Äì Fair Market Value</label>
            <input type="number" name="ed_fair_market_value" step="0.01" placeholder="0.00"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Common footer fields ‚îÄ‚îÄ -->
      <div class="field-section">
        <div class="form-grid">
          <div class="form-group">
            <label>Status</label>
            <select id="f_status" name="status">
              <option value="uploaded">üì• Uploaded</option>
              <option value="expected">‚è≥ Expected</option>
              <option value="filed">‚úÖ Filed</option>
            </select>
          </div>
          <div class="form-group">
            <label>Document File <span style="color:#94a3b8;font-weight:400;">(PDF / image)</span></label>
            <input type="file" id="f_file" name="file" accept=".pdf,.jpg,.jpeg,.png">
          </div>
          <div class="form-group span2">
            <label>Notes <span style="color:#94a3b8;font-weight:400;">(optional)</span></label>
            <textarea id="f_notes" name="notes" rows="2"
                      placeholder="e.g., corrected W-2, multiple ESPP lots, etc."></textarea>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" id="submitBtn">Save Document</button>
      </div>
    </form>
  </div>
</div>

<script>
const YEAR = {{ year | tojson }};
const DOCS_DATA = {{ docs_json | safe }};
const SECTION_IDS = ['W2', '1099_INT', '1098_T', '1098', '3922', '1099_CONSOLIDATED', '1099_R', 'SSA_1099', '1099_SA'];

function onFormTypeChange(val) {
  SECTION_IDS.forEach(id => {
    const el = document.getElementById('fields-' + id);
    if (el) el.style.display = (id === val) ? 'block' : 'none';
  });
}

function enableAllInputs() {
  SECTION_IDS.forEach(id => {
    const sec = document.getElementById('fields-' + id);
    if (sec) sec.querySelectorAll('input,select,textarea')
                .forEach(el => el.disabled = false);
  });
}

// Disable hidden sections on submit so duplicate field names don't cross-contaminate
document.getElementById('taxForm').addEventListener('submit', function () {
  SECTION_IDS.forEach(id => {
    const sec = document.getElementById('fields-' + id);
    if (sec && sec.style.display === 'none')
      sec.querySelectorAll('input,select,textarea').forEach(el => el.disabled = true);
  });
});

function openAddModal() {
  enableAllInputs();
  const form = document.getElementById('taxForm');
  form.reset();
  form.action = '/tax/add';
  document.getElementById('modalTitle').textContent = 'Add Tax Document';
  document.getElementById('submitBtn').textContent  = 'Save Document';
  document.getElementById('f_tax_year').value = YEAR;
  onFormTypeChange(document.getElementById('f_form_type').value);
  document.getElementById('taxModal').classList.add('open');
}

function openEditModal(docId) {
  const doc = DOCS_DATA.find(d => d.id === docId);
  if (!doc) return;
  enableAllInputs();
  const form = document.getElementById('taxForm');
  form.reset();
  form.action = '/tax/' + docId + '/edit';
  document.getElementById('modalTitle').textContent = 'Edit Tax Document';
  document.getElementById('submitBtn').textContent  = 'Save Changes';
  document.getElementById('f_tax_year').value    = doc.tax_year;
  document.getElementById('f_form_type').value   = doc.form_type;
  document.getElementById('f_issuer').value      = doc.issuer || '';
  document.getElementById('f_description').value = doc.description || '';
  document.getElementById('f_status').value      = doc.status || 'uploaded';
  document.getElementById('f_notes').value       = doc.notes || '';
  onFormTypeChange(doc.form_type);
  // Populate extracted data fields
  const ed = doc.ed || {};
  for (const [k, v] of Object.entries(ed)) {
    const inp = form.querySelector('[name="ed_' + k + '"]:not([disabled])');
    if (inp) inp.value = v;
  }
  document.getElementById('taxModal').classList.add('open');
}

function closeModal() {
  document.getElementById('taxModal').classList.remove('open');
}

function toggleDetail(docId) {
  const row = document.getElementById('detail-' + docId);
  const btn = document.getElementById('btn-detail-' + docId);
  const open = row.style.display === 'none';
  row.style.display = open ? '' : 'none';
  btn.textContent   = open ? '‚ñæ' : '‚ñ∏';
}

async function updateStatus(docId, status) {
  const fd = new FormData();
  fd.append('status', status);
  await fetch('/tax/' + docId + '/status', { method: 'POST', body: fd });
}

// Close modal on backdrop click
document.getElementById('taxModal').addEventListener('click', function (e) {
  if (e.target === this) closeModal();
});

// Initialise with first form type
onFormTypeChange(document.getElementById('f_form_type').value);

// ‚îÄ‚îÄ OCR Scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function scanDocument(docId) {
  // If the edit modal is already open and has data, warn before overwriting
  const modal = document.getElementById('taxModal');
  const isOpen = modal && modal.style.display !== 'none';
  if (isOpen) {
    const form = document.getElementById('taxForm');
    const filled = [...form.querySelectorAll('input, textarea, select')]
      .some(el => el.name && el.name.startsWith('ed_') && el.value && el.value.trim());
    if (filled && !confirm('The edit form already has data.\nScan will overwrite filled fields with OCR values ‚Äî continue?')) {
      return;
    }
  }
  const btn = document.getElementById('scan-btn-' + docId);
  const origHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="scan-spinner"></span>Scanning‚Ä¶';
  showToast('üîç Running OCR scan‚Ä¶', 0);

  let data;
  try {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), 70000); // 70 s client timeout
    const resp = await fetch('/tax/' + docId + '/scan', { method: 'POST', signal: ctrl.signal });
    clearTimeout(timer);
    data = await resp.json();
  } catch (e) {
    const msg = e.name === 'AbortError' ? 'Scan timed out ‚Äî file may be too large or complex.' : 'Network error: ' + e.message;
    showToast('‚ùå ' + msg);
    btn.disabled = false; btn.innerHTML = origHTML;
    return;
  }

  btn.disabled = false;
  btn.innerHTML = origHTML;

  if (data._error) {
    showToast('‚ö†Ô∏è ' + data._error);
    return;
  }

  // Open the edit modal and fill OCR values
  openEditModal(docId);

  // Apply extracted values ‚Äî highlight filled fields in yellow
  const form = document.getElementById('taxForm');
  let hits = 0, misses = 0;

  // Top-level doc fields (not inside extracted_data)
  const topFieldMap = { issuer: 'f_issuer', description: 'f_description' };
  for (const [k, elId] of Object.entries(topFieldMap)) {
    if (data[k]) {
      const el = document.getElementById(elId);
      if (el && !el.value.trim()) { el.value = data[k]; el.classList.add('scan-field-hit'); hits++; }
    }
  }

  for (const [k, v] of Object.entries(data)) {
    if (k.startsWith('_') || !v || k in topFieldMap) continue;
    const inp = form.querySelector('[name="ed_' + k + '"]');
    if (inp && !inp.disabled) {
      if (inp.value && inp.value.trim()) { misses++; continue; } // don't overwrite existing data
      inp.value = v;
      inp.classList.add('scan-field-hit');
      hits++;
    } else {
      misses++;
    }
  }

  // Show raw preview in notes if notes is empty
  const notesEl = document.getElementById('f_notes');
  if (data._raw_preview && !notesEl.value) {
    // don't pollute notes ‚Äî just surface in toast
  }

  const msg = hits > 0
    ? `‚úÖ Scan complete ‚Äî ${hits} field${hits > 1 ? 's' : ''} filled (highlighted in yellow). Review before saving.`
    : '‚ö†Ô∏è Scan ran but no fields could be extracted. Check form type or file quality.';
  showToast(msg, hits > 0 ? 5000 : 8000);
}

let _toastTimer = null;
function showToast(msg, duration = 4000) {
  let el = document.getElementById('scanToast');
  if (!el) {
    el = document.createElement('div');
    el.id = 'scanToast';
    el.className = 'scan-toast hidden';
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.classList.remove('hidden');
  if (_toastTimer) clearTimeout(_toastTimer);
  if (duration > 0) _toastTimer = setTimeout(() => el.classList.add('hidden'), duration);
}
</script>

<!-- ‚ïê‚ïê File Preview Modal ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="previewModal" class="modal-overlay">
  <div class="modal-box" style="max-width:840px;width:95vw;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <h2 id="previewTitle" style="margin:0;">Document Preview</h2>
      <button class="btn btn-ghost" onclick="closePreview()" style="padding:0.25rem 0.65rem;">‚úï</button>
    </div>
    <div id="previewContent" style="width:100%;min-height:420px;"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:1rem;padding-top:0.75rem;
                border-top:1px solid #e2e8f0;gap:0.5rem;">
      <a id="previewDownload" href="#" class="btn btn-ghost" download>‚¨á Download</a>
      <button class="btn btn-ghost" onclick="closePreview()">Close</button>
    </div>
  </div>
</div>

<script>
function openPreview(docId) {
  const doc  = DOCS_DATA.find(d => d.id === docId);
  const ct   = doc ? (doc.content_type || '') : '';
  const name = doc ? (doc.original_name || 'Document') : 'Document';
  document.getElementById('previewTitle').textContent = name;
  document.getElementById('previewDownload').href = '/tax/' + docId + '/file';
  const src = '/tax/' + docId + '/preview';
  const container = document.getElementById('previewContent');
  if (ct.startsWith('image/')) {
    container.innerHTML = `<img src="${src}" style="max-width:100%;border-radius:6px;display:block;margin:0 auto;">`;
  } else {
    container.innerHTML = `<iframe src="${src}" style="width:100%;height:620px;border:none;border-radius:6px;" title="${name}"></iframe>`;
  }
  document.getElementById('previewModal').classList.add('open');
}
function closePreview() {
  document.getElementById('previewModal').classList.remove('open');
  document.getElementById('previewContent').innerHTML = '';
}
document.getElementById('previewModal').addEventListener('click', function (e) {
  if (e.target === this) closePreview();
});
</script>

{% endblock %}
