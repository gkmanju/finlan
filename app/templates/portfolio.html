{% extends "base.html" %}
{% block content %}
<style>
  .admin-btn { display: none !important; }
  body.admin-mode .admin-btn { display: inline-block !important; }
</style>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h2 style="margin: 0;">Portfolio Dashboard</h2>
  <div style="display: flex; gap: 12px; align-items: center;">
    <button id="adminToggleBtn" onclick="toggleAdminMode()" style="background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; padding: 9px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">üîí Admin Mode</button>
    <a href="/portfolio/upload" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">üìÅ Import Data</a>
    <a href="/portfolio/connect" style="background: #6366f1; color: white; border: none; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">üîó Connect Accounts</a>
  </div>
</div>

<!-- Tab Navigation -->
<div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
  <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn active" style="padding: 12px 24px; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid #6366f1; color: #6366f1;">Overview</button>
  <button onclick="switchTab('holdings')" id="tab-holdings" class="tab-btn" style="padding: 12px 24px; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; color: #6b7280;">Holdings</button>
  <button onclick="switchTab('transactions')" id="tab-transactions" class="tab-btn" style="padding: 12px 24px; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; color: #6b7280;">Transactions</button>
</div>

<!-- Overview Tab -->
<div id="overview-tab" class="tab-content">

<!-- Metric Bar -->
<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 24px;">
  <div style="background: white; border-radius: 12px; padding: 18px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.07); border-left: 4px solid #6366f1;">
    <div style="font-size: 11px; font-weight: 700; color: #6366f1; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px;">Net Worth</div>
    <div id="netWorth" style="font-size: 1.6rem; font-weight: 700; color: #1e293b;">-</div>
  </div>
  <div style="background: white; border-radius: 12px; padding: 18px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.07); border-left: 4px solid #8b5cf6;">
    <div style="font-size: 11px; font-weight: 700; color: #8b5cf6; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px;">Investments</div>
    <div id="totalInvestments" style="font-size: 1.6rem; font-weight: 700; color: #1e293b;">-</div>
  </div>
  <div style="background: white; border-radius: 12px; padding: 18px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.07); border-left: 4px solid #10b981;">
    <div style="font-size: 11px; font-weight: 700; color: #10b981; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px;">Cash &amp; Savings</div>
    <div id="totalCash" style="font-size: 1.6rem; font-weight: 700; color: #1e293b;">-</div>
  </div>
  <div style="background: white; border-radius: 12px; padding: 18px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.07); border-left: 4px solid #f43f5e;">
    <div style="font-size: 11px; font-weight: 700; color: #f43f5e; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px;">Credit Card Debt</div>
    <div id="totalCreditDebt" style="font-size: 1.6rem; font-weight: 700; color: #1e293b;">-</div>
  </div>
  <div style="background: white; border-radius: 12px; padding: 18px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.07); border-left: 4px solid #0ea5e9;">
    <div style="font-size: 11px; font-weight: 700; color: #0ea5e9; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px;">Holdings</div>
    <div id="holdingsCount" style="font-size: 1.6rem; font-weight: 700; color: #1e293b;">-</div>
  </div>
</div>

<!-- Pie Chart + Accounts -->
<div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; margin-bottom: 28px;">

  <!-- Asset Allocation Pie -->
  <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.07);">
    <h3 style="margin: 0 0 14px 0; font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.06em;">Asset Allocation</h3>
    <canvas id="allocationChart" width="260" height="260" style="display: block; margin: 0 auto;"></canvas>
    <div id="chartLegend" style="margin-top: 14px; display: flex; flex-direction: column; gap: 6px;"></div>
  </div>

  <!-- Account panels (side by side) -->
  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; align-items: start;">
    <div style="background: white; border-radius: 12px; padding: 14px 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.07);">
      <h3 style="margin: 0 0 8px 0; font-size: 11px; font-weight: 700; color: #8b5cf6; text-transform: uppercase; letter-spacing: 0.06em;">üìä Brokerage &amp; Retirement</h3>
      <div id="investmentAccounts"><p style="color: #9ca3af; font-size: 13px;">No investment accounts yet.</p></div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 14px 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.07);">
      <h3 style="margin: 0 0 8px 0; font-size: 11px; font-weight: 700; color: #10b981; text-transform: uppercase; letter-spacing: 0.06em;">üè¶ Checking &amp; Savings</h3>
      <div id="bankAccounts"><p style="color: #9ca3af; font-size: 13px;">No bank accounts yet.</p></div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 14px 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.07);">
      <h3 style="margin: 0 0 8px 0; font-size: 11px; font-weight: 700; color: #f43f5e; text-transform: uppercase; letter-spacing: 0.06em;">üí≥ Credit Cards</h3>
      <div id="creditCardAccounts"><p style="color: #9ca3af; font-size: 13px;">No credit cards found.</p></div>
    </div>
  </div>
</div>
</div>

<!-- Holdings Tab -->
<div id="holdings-tab" class="tab-content" style="display: none;">
  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
      <h3 style="margin: 0;">Investment Holdings</h3>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <select id="holdingAccountFilter" onchange="applyHoldingFilters()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
          <option value="all">All Accounts</option>
        </select>
        <select id="assetTypeFilter" onchange="applyHoldingFilters()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
          <option value="all">All Asset Types</option>
          <option value="stock">Stocks</option>
          <option value="mutual fund">Mutual Funds</option>
          <option value="etf">ETFs</option>
          <option value="bond">Bonds</option>
          <option value="cash">Cash</option>
        </select>
        <input type="text" id="symbolSearch" onkeyup="applyHoldingFilters()" placeholder="Search symbol..." style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; width: 150px;">
        <button onclick="clearHoldingFilters()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Clear Filters</button>
        <button onclick="updateLivePrices(event)" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">üîÑ Update Prices</button>
      </div>
    </div>
    <div id="holdingsStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 8px;">
      <div><strong>Total Holdings:</strong> <span id="holdingsTotal">0</span></div>
      <div><strong>Total Value:</strong> <span id="holdingsValue">$0.00</span></div>
      <div><strong>Total Gain/Loss:</strong> <span id="holdingsGainLoss">$0.00</span></div>
      <div><strong>Filtered:</strong> <span id="holdingsFiltered">0</span></div>
      <div><strong>Data As Of:</strong> <span id="holdingsDate">-</span></div>
    </div>
    <div style="overflow-x: auto;">
      <table id="holdingsTable" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #1f2937; color: white;">
            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortHoldingsTable(0)">Institution ‚áÖ</th>
            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortHoldingsTable(1)">Account ‚áÖ</th>
            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortHoldingsTable(2)">Account # ‚áÖ</th>
            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortHoldingsTable(3)">Symbol ‚áÖ</th>
            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortHoldingsTable(4)">Name ‚áÖ</th>
            <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="sortHoldingsTable(5)">Quantity ‚áÖ</th>
            <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="sortHoldingsTable(6)">Price ‚áÖ</th>
            <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="sortHoldingsTable(7)">Value ‚áÖ</th>
            <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="sortHoldingsTable(8)">Gain/Loss ‚áÖ</th>
            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortHoldingsTable(9)">Type ‚áÖ</th>
          </tr>
        </thead>
        <tbody id="holdingsBody">
          <tr>
            <td colspan="8" style="padding: 20px; text-align: center; color: #6b7280;">No holdings data. Import CSV files to see your portfolio.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Transactions Tab -->
<div id="transactions-tab" class="tab-content" style="display: none;">
  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
      <h3 style="margin: 0;">Transaction History</h3>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <select id="txnAccountFilter" onchange="applyTransactionFilters()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
          <option value="all">All Accounts</option>
        </select>
        <select id="txnTypeFilter" onchange="applyTransactionFilters()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
          <option value="all">All Types</option>
          <option value="positive">Income/Deposits</option>
          <option value="negative">Expenses/Withdrawals</option>
        </select>
        <input type="date" id="txnDateFrom" onchange="applyTransactionFilters()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
        <input type="date" id="txnDateTo" onchange="applyTransactionFilters()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
        <input type="text" id="txnSearch" onkeyup="applyTransactionFilters()" placeholder="Search description..." style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; width: 180px;">
        <button onclick="clearTransactionFilters()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Clear Filters</button>
      </div>
    </div>
    <div id="transactionsStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 8px;">
      <div><strong>Total Transactions:</strong> <span id="txnTotal">0</span></div>
      <div><strong>Income:</strong> <span id="txnIncome" style="color: #10b981;">$0.00</span></div>
      <div><strong>Expenses:</strong> <span id="txnExpenses" style="color: #ef4444;">$0.00</span></div>
      <div><strong>Filtered:</strong> <span id="txnFiltered">0</span></div>
    </div>
    <div style="overflow-x: auto;">
      <table id="transactionsTable" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #1e293b;">
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #334155; cursor: pointer; color: #f1f5f9; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;" onclick="sortTransactionsTable(0)">Date ‚áÖ</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #334155; cursor: pointer; color: #f1f5f9; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;" onclick="sortTransactionsTable(1)">Account ‚áÖ</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #334155; cursor: pointer; color: #f1f5f9; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;" onclick="sortTransactionsTable(2)">Description ‚áÖ</th>
            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #334155; cursor: pointer; color: #f1f5f9; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;" onclick="sortTransactionsTable(3)">Amount ‚áÖ</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #334155; cursor: pointer; color: #f1f5f9; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;" onclick="sortTransactionsTable(4)">Category ‚áÖ</th>
          </tr>
        </thead>
        <tbody id="transactionsBody">
          <tr>
            <td colspan="5" style="padding: 20px; text-align: center; color: #6b7280;">No transactions data. Import CSV files to see transaction history.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% raw %}
<script>
let allHoldings = [];
let allTransactions = [];

// Tab switching
function toggleAdminMode() {
  const active = document.body.classList.toggle('admin-mode');
  const btn = document.getElementById('adminToggleBtn');
  btn.textContent = active ? 'üîì Admin Mode' : 'üîí Admin Mode';
  btn.style.background = active ? '#fef3c7' : '#f1f5f9';
  btn.style.color = active ? '#d97706' : '#64748b';
  btn.style.borderColor = active ? '#fcd34d' : '#e2e8f0';
}

function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.style.borderBottomColor = 'transparent';
    btn.style.color = '#6b7280';
  });
  
  // Show selected tab
  document.getElementById(tabName + '-tab').style.display = 'block';
  const btn = document.getElementById('tab-' + tabName);
  btn.style.borderBottomColor = '#6366f1';
  btn.style.color = '#6366f1';
}

// Format a YYYY-MM-DD date string without timezone shifting
function fmtDate(d) {
  if (!d) return '‚Äî';
  const [y, m, day] = String(d).split('T')[0].split('-').map(Number);
  return new Date(y, m - 1, day).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Helper function to format numbers with commas
function formatMoney(num) {
  return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Draw asset allocation donut chart
function drawPieChart(data) {
  const canvas = document.getElementById('allocationChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const segments = [
    { label: 'Investments', value: data.total_investments || 0, color: '#8b5cf6' },
    { label: 'Cash & Savings', value: data.total_cash || 0, color: '#10b981' },
    { label: 'Credit Debt', value: data.total_credit_debt || 0, color: '#f43f5e' },
  ].filter(s => s.value > 0);

  const total = segments.reduce((s, seg) => s + seg.value, 0);
  if (total === 0) { ctx.clearRect(0, 0, canvas.width, canvas.height); return; }

  const cx = canvas.width / 2, cy = canvas.height / 2;
  const outerR = Math.min(cx, cy) - 8;
  const innerR = outerR * 0.55;
  let angle = -Math.PI / 2;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  segments.forEach(seg => {
    const slice = (seg.value / total) * 2 * Math.PI;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, outerR, angle, angle + slice);
    ctx.closePath();
    ctx.fillStyle = seg.color;
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
    angle += slice;
  });

  // Punch donut hole
  ctx.beginPath();
  ctx.arc(cx, cy, innerR, 0, 2 * Math.PI);
  ctx.fillStyle = '#fff';
  ctx.fill();

  // Center label
  ctx.fillStyle = '#111827';
  ctx.font = 'bold 13px system-ui, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  const netLabel = (data.net_worth >= 0 ? '$' : '-$') + Math.abs(data.net_worth).toLocaleString('en-US', {maximumFractionDigits: 0});
  ctx.fillText(netLabel, cx, cy - 8);
  ctx.font = '10px system-ui, sans-serif';
  ctx.fillStyle = '#6b7280';
  ctx.fillText('Net Worth', cx, cy + 8);

  // Legend
  const legend = document.getElementById('chartLegend');
  if (legend) {
    legend.innerHTML = segments.map(seg => {
      const pct = ((seg.value / total) * 100).toFixed(1);
      const val = '$' + seg.value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
      return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:5px;">
        <div style="width:10px;height:10px;border-radius:2px;background:${seg.color};flex-shrink:0;"></div>
        <span style="font-size:12px;color:#374151;flex:1;">${seg.label}</span>
        <span style="font-size:11px;color:#6b7280;">${pct}%</span>
        <span style="font-size:11px;font-weight:600;color:#111827;">${val}</span>
      </div>`;
    }).join('');
  }
}

// Load portfolio data
function loadPortfolioData() {
  // Load summary
  fetch('/portfolio/summary')
    .then(r => r.json())
    .then(data => {
      document.getElementById('netWorth').textContent = '$' + data.net_worth.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('totalInvestments').textContent = '$' + data.total_investments.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('totalCash').textContent = '$' + data.total_cash.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('totalCreditDebt').textContent = '$' + (data.total_credit_debt || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('holdingsCount').textContent = data.holdings_count;

      // Helper: render an account list grouped by institution
      function renderAccountGroup(accounts, accentColor, isDebt) {
        if (!accounts || !accounts.length) return '<p style="color:#6b7280;font-size:13px;">None found.</p>';
        const grouped = {};
        accounts.forEach(acc => {
          if (!grouped[acc.institution]) grouped[acc.institution] = [];
          grouped[acc.institution].push(acc);
        });
        return Object.keys(grouped).sort().map(inst => `
          <div style="margin-bottom: 16px;">
            <div style="font-weight: 700; color: ${accentColor}; font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #e5e7eb;">üè¶ ${inst}</div>
            ${grouped[inst].map(acc => {
              const balColor = isDebt ? '#dc2626' : '#111827';
              const balPrefix = isDebt ? '-' : '';
              const typeBadge = acc.account_type === 'savings'
                ? `<span style="background:#dbeafe;color:#1d4ed8;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:700;margin-left:6px;">SAVINGS</span>`
                : acc.account_type === 'checking'
                ? `<span style="background:#dcfce7;color:#15803d;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:700;margin-left:6px;">CHECKING</span>`
                : '';
              return `
              <div style="padding: 7px 0 7px 8px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px;">
                <div style="min-width:0; flex:1;">
                  <div style="font-weight: 600; color: #111827; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${acc.account_name}${typeBadge}</div>
                  <div style="font-size: 10px; color: #9ca3af; margin-top: 1px;">üë§ ${acc.owner}${acc.account_number_last4 ? ' ¬∑ ¬∑¬∑¬∑¬∑' + acc.account_number_last4 : ''}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 6px; flex-shrink: 0;">
                  <div style="font-weight: 700; color: ${balColor}; font-size: 13px; white-space: nowrap;">${balPrefix}$${formatMoney(acc.balance)}</div>
                  <button onclick="editAccountOwner(${acc.id}, '${acc.owner.replaceAll("'", "\\'")}'  , ${acc.account_type !== 'investment'})" class="admin-btn" style="padding: 3px 7px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Edit</button>
                  <button onclick="deleteAccount(${acc.id})" class="admin-btn" style="padding: 3px 7px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Del</button>
                </div>
              </div>`;
            }).join('')}
          </div>
        `).join('');
      }

      // Render investment accounts
      if (data.investment_accounts && data.investment_accounts.length > 0) {
        document.getElementById('investmentAccounts').innerHTML = renderAccountGroup(data.investment_accounts, '#7c3aed', false);
      }

      // Render checking + savings (combined, type badge distinguishes them)
      const bankAccounts = (data.checking_accounts || []).concat(data.savings_accounts || []);
      if (bankAccounts.length > 0) {
        document.getElementById('bankAccounts').innerHTML = renderAccountGroup(bankAccounts, '#16a34a', false);
      }

      // Render credit cards
      if (data.credit_card_accounts && data.credit_card_accounts.length > 0) {
        document.getElementById('creditCardAccounts').innerHTML = renderAccountGroup(data.credit_card_accounts, '#dc2626', true);
      }

      // Draw asset allocation pie chart
      drawPieChart(data);
    })
    .catch(err => console.error('Error loading summary:', err));
  
  // Load holdings
  fetch('/portfolio/holdings')
    .then(r => r.json())
    .then(data => {
      allHoldings = data;
      if (data.length > 0) {
        // Populate account filters
        const accounts = [...new Set(data.map(h => h.account))].sort();
        const holdingFilter = document.getElementById('holdingAccountFilter');
        if (holdingFilter) {
           const safeAccounts = accounts.map(acc => {
               const safeVal = acc.replace(/"/g, '&quot;'); 
               return `<option value="${safeVal}">${acc}</option>`;
           }).join('');
           holdingFilter.innerHTML = '<option value="all">All Accounts</option>' + safeAccounts;
        }
        renderHoldings(data);
      }
    })
    .catch(err => console.error('Error loading holdings:', err));
  
  // Load transactions
  fetch('/portfolio/transactions?limit=1000')
    .then(r => r.json())
    .then(data => {
      allTransactions = data;
      if (data.length > 0) {
        // Populate transaction account filter
        const accounts = [...new Set(data.map(t => t.account))].sort();
        const txnFilter = document.getElementById('txnAccountFilter');
        if (txnFilter) {
           const safeAccounts = accounts.map(acc => {
               const safeVal = acc.replace(/"/g, '&quot;'); 
               return `<option value="${safeVal}">${acc}</option>`;
           }).join('');
           txnFilter.innerHTML = '<option value="all">All Accounts</option>' + safeAccounts;
        }
        renderTransactions(data);
      }
    })
    .catch(err => console.error('Error loading transactions:', err));
}

// Render functions
function renderHoldings(holdings, updatedSymbols = []) {
  if (holdings.length === 0) {
    document.getElementById('holdingsBody').innerHTML = '<tr><td colspan="9" style="padding: 20px; text-align: center; color: #6b7280;">No holdings match the filters.</td></tr>';
    updateHoldingsStats(holdings);
    return;
  }
  
  const html = holdings.map(h => {
    const gainLoss = h.gain_loss !== null ? h.gain_loss : 0;
    const gainLossColor = gainLoss >= 0 ? '#10b981' : '#ef4444';
    const gainLossSign = gainLoss >= 0 ? '+' : '';
    const safeAccountAttr = h.account.replace(/"/g, '&quot;');
    const isUpdated = updatedSymbols.includes(h.symbol);
    const rowClass = isUpdated ? ' class="price-updated"' : '';
    
    return `
      <tr${rowClass} style="border-bottom: 1px solid #e5e7eb;" data-account="${safeAccountAttr}" data-symbol="${h.symbol}" data-type="${h.asset_type || ''}">
        <td style="padding: 12px; font-weight: 600; color: #6366f1;">${h.institution || 'Unknown'}</td>
        <td style="padding: 12px;">${h.account}</td>
        <td style="padding: 12px; color: #6b7280; font-family: monospace;">${h.account_number_last4 ? '‚óè‚óè‚óè‚óè ' + h.account_number_last4 : '-'}</td>
        <td style="padding: 12px; font-weight: 600;">${h.symbol}</td>
        <td style="padding: 12px;">${h.name || '-'}</td>
        <td style="padding: 12px; text-align: right;">${formatMoney(h.quantity)}</td>
        <td style="padding: 12px; text-align: right;">$${h.current_price ? formatMoney(h.current_price) : '-'}</td>
        <td style="padding: 12px; text-align: right; font-weight: 600;">$${h.current_value ? formatMoney(h.current_value) : '-'}</td>
        <td style="padding: 12px; text-align: right; color: ${gainLossColor}; font-weight: 600;">${gainLossSign}$${formatMoney(Math.abs(gainLoss))}</td>
        <td style="padding: 12px;">${h.asset_type || '-'}</td>
      </tr>
    `;
  }).join('');
  document.getElementById('holdingsBody').innerHTML = html;
  updateHoldingsStats(holdings);
}

function renderTransactions(transactions) {
  if (transactions.length === 0) {
    document.getElementById('transactionsBody').innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #6b7280;">No transactions match the filters.</td></tr>';
    updateTransactionsStats(transactions);
    return;
  }
  
  const html = transactions.map(t => {
    const amountColor = t.amount >= 0 ? '#10b981' : '#ef4444';
    const amountSign = t.amount >= 0 ? '+' : '';
    
    return `
      <tr style="border-bottom: 1px solid #e5e7eb;" data-account="${t.account}" data-date="${t.date}" data-amount="${t.amount}" data-description="${t.description.toLowerCase()}">
        <td style="padding: 12px;">${fmtDate(t.date)}</td>
        <td style="padding: 12px;">${t.account}</td>
        <td style="padding: 12px;">${t.description}</td>
        <td style="padding: 12px; text-align: right; color: ${amountColor}; font-weight: 600;">${amountSign}$${formatMoney(Math.abs(t.amount))}</td>
        <td style="padding: 12px;">${t.category || '-'}</td>
      </tr>
    `;
  }).join('');
  document.getElementById('transactionsBody').innerHTML = html;
  updateTransactionsStats(transactions);
}

// Filter functions
function applyHoldingFilters(updatedSymbols = []) {
  const account = document.getElementById('holdingAccountFilter').value;
  const assetType = document.getElementById('assetTypeFilter').value;
  const symbolSearch = document.getElementById('symbolSearch').value.toLowerCase();
  
  let filtered = allHoldings;
  
  if (account !== 'all') {
    filtered = filtered.filter(h => h.account === account);
  }
  
  if (assetType !== 'all') {
    filtered = filtered.filter(h => h.asset_type && h.asset_type.toLowerCase() === assetType);
  }
  
  if (symbolSearch) {
    filtered = filtered.filter(h => h.symbol.toLowerCase().includes(symbolSearch) || (h.name && h.name.toLowerCase().includes(symbolSearch)));
  }
  
  renderHoldings(filtered, updatedSymbols);
}

function clearHoldingFilters() {
  document.getElementById('holdingAccountFilter').value = 'all';
  document.getElementById('assetTypeFilter').value = 'all';
  document.getElementById('symbolSearch').value = '';
  renderHoldings(allHoldings);
}

function applyTransactionFilters() {
  const account = document.getElementById('txnAccountFilter').value;
  const type = document.getElementById('txnTypeFilter').value;
  const dateFrom = document.getElementById('txnDateFrom').value;
  const dateTo = document.getElementById('txnDateTo').value;
  const search = document.getElementById('txnSearch').value.toLowerCase();
  
  let filtered = allTransactions;
  
  if (account !== 'all') {
    filtered = filtered.filter(t => t.account === account);
  }
  
  if (type === 'positive') {
    filtered = filtered.filter(t => t.amount >= 0);
  } else if (type === 'negative') {
    filtered = filtered.filter(t => t.amount < 0);
  }
  
  if (dateFrom) {
    filtered = filtered.filter(t => t.date >= dateFrom);
  }
  
  if (dateTo) {
    filtered = filtered.filter(t => t.date <= dateTo);
  }
  
  if (search) {
    filtered = filtered.filter(t => t.description.toLowerCase().includes(search));
  }
  
  renderTransactions(filtered);
}

function clearTransactionFilters() {
  document.getElementById('txnAccountFilter').value = 'all';
  document.getElementById('txnTypeFilter').value = 'all';
  document.getElementById('txnDateFrom').value = '';
  document.getElementById('txnDateTo').value = '';
  document.getElementById('txnSearch').value = '';
  renderTransactions(allTransactions);
}

// Stats update functions
function updateHoldingsStats(holdings) {
  const totalValue = holdings.reduce((sum, h) => sum + (h.current_value || 0), 0);
  const totalGainLoss = holdings.reduce((sum, h) => sum + (h.gain_loss || 0), 0);
  
  document.getElementById('holdingsTotal').textContent = allHoldings.length;
  document.getElementById('holdingsValue').textContent = '$' + totalValue.toLocaleString('en-US', {minimumFractionDigits: 2});
  document.getElementById('holdingsGainLoss').textContent = '$' + totalGainLoss.toLocaleString('en-US', {minimumFractionDigits: 2});
  document.getElementById('holdingsGainLoss').style.color = totalGainLoss >= 0 ? '#10b981' : '#ef4444';
  document.getElementById('holdingsFiltered').textContent = holdings.length;
  
  // Find most recent snapshot date
  const snapshotDate = allHoldings.reduce((latest, h) => {
    if (!h.snapshot_date) return latest;
    const hDate = new Date(h.snapshot_date);
    return !latest || hDate > new Date(latest) ? h.snapshot_date : latest;
  }, null);
  
  if (snapshotDate) {
    const date = new Date(snapshotDate);
    document.getElementById('holdingsDate').textContent = date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } else {
    document.getElementById('holdingsDate').textContent = 'N/A';
  }
}

async function updateLivePrices(event) {
  const button = event.target;
  const originalText = button.innerHTML;
  
  try {
    button.disabled = true;
    button.innerHTML = '‚è≥ Updating...';
    
    // Store current prices to compare
    const oldPrices = {};
    allHoldings.forEach(h => {
      if (h.symbol && h.current_price) {
        oldPrices[h.symbol] = h.current_price;
      }
    });
    
    const response = await fetch('/portfolio/sync/prices', {
      method: 'POST'
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.detail || 'Failed to update prices');
    }
    
    const data = await response.json();
    
    // Show success message with count
    button.innerHTML = `‚úì Updated ${data.updated}`;
    button.style.backgroundColor = '#10b981';
    
    // Reload holdings data
    const holdingsResponse = await fetch('/portfolio/holdings');
    const newHoldings = await holdingsResponse.json();
    allHoldings = newHoldings;
    
    // Identify which symbols had price changes
    const updatedSymbols = [];
    newHoldings.forEach(h => {
      if (h.symbol && h.current_price && oldPrices[h.symbol] && oldPrices[h.symbol] !== h.current_price) {
        updatedSymbols.push(h.symbol);
      }
    });
    
    // Re-render with highlights
    applyHoldingFilters(updatedSymbols);
    
    // Reset button after 2 seconds
    setTimeout(() => {
      button.innerHTML = originalText;
      button.style.backgroundColor = '#10b981';
      button.disabled = false;
    }, 2000);
    
  } catch (error) {
    console.error('Error updating prices:', error);
    alert('Failed to update prices: ' + error.message);
    button.innerHTML = originalText;
    button.disabled = false;
  }
}

function updateTransactionsStats(transactions) {
  const income = transactions.reduce((sum, t) => sum + (t.amount >= 0 ? t.amount : 0), 0);
  const expenses = transactions.reduce((sum, t) => sum + (t.amount < 0 ? Math.abs(t.amount) : 0), 0);
  
  document.getElementById('txnTotal').textContent = allTransactions.length;
  document.getElementById('txnIncome').textContent = '$' + income.toLocaleString('en-US', {minimumFractionDigits: 2});
  document.getElementById('txnExpenses').textContent = '$' + expenses.toLocaleString('en-US', {minimumFractionDigits: 2});
  document.getElementById('txnFiltered').textContent = transactions.length;
}

// Sorting functions
let holdingSortColumn = -1;
let holdingSortAsc = true;

function sortHoldingsTable(col) {
  if (holdingSortColumn === col) {
    holdingSortAsc = !holdingSortAsc;
  } else {
    holdingSortColumn = col;
    holdingSortAsc = true;
  }
  
  const sorted = [...allHoldings].sort((a, b) => {
    let aVal, bVal;
    switch(col) {
      case 0: aVal = a.account; bVal = b.account; break;
      case 1: aVal = a.symbol; bVal = b.symbol; break;
      case 2: aVal = a.name || ''; bVal = b.name || ''; break;
      case 3: aVal = a.quantity; bVal = b.quantity; break;
      case 4: aVal = a.current_price || 0; bVal = b.current_price || 0; break;
      case 5: aVal = a.current_value || 0; bVal = b.current_value || 0; break;
      case 6: aVal = a.gain_loss || 0; bVal = b.gain_loss || 0; break;
      case 7: aVal = a.asset_type || ''; bVal = b.asset_type || ''; break;
    }
    
    if (typeof aVal === 'string') {
      return holdingSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    } else {
      return holdingSortAsc ? aVal - bVal : bVal - aVal;
    }
  });
  
  allHoldings = sorted;
  applyHoldingFilters();
}

let txnSortColumn = -1;
let txnSortAsc = true;

function sortTransactionsTable(col) {
  if (txnSortColumn === col) {
    txnSortAsc = !txnSortAsc;
  } else {
    txnSortColumn = col;
    txnSortAsc = true;
  }
  
  const sorted = [...allTransactions].sort((a, b) => {
    let aVal, bVal;
    switch(col) {
      case 0: aVal = a.date; bVal = b.date; break;
      case 1: aVal = a.account; bVal = b.account; break;
      case 2: aVal = a.description; bVal = b.description; break;
      case 3: aVal = a.amount; bVal = b.amount; break;
      case 4: aVal = a.category || ''; bVal = b.category || ''; break;
    }
    
    if (typeof aVal === 'string') {
      return txnSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    } else {
      return txnSortAsc ? aVal - bVal : bVal - aVal;
    }
  });
  
  allTransactions = sorted;
  applyTransactionFilters();
}

async function deleteAccount(accountId) {
  if (!confirm('Are you sure you want to delete this account? This will also delete all associated holdings.')) {
    return;
  }
  
  try {
    const response = await fetch(`/portfolio/accounts/${accountId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      alert('Account deleted successfully');
      loadPortfolioData();
    } else {
      alert('Error deleting account');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error deleting account');
  }
}

async function editAccountOwner(accountId, currentOwner) {
  const newOwner = prompt('Enter account owner name:', currentOwner === 'Not specified' ? '' : currentOwner);
  
  if (newOwner === null || newOwner.trim() === '') {
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('account_holder', newOwner.trim());
    
    const response = await fetch(`/portfolio/accounts/${accountId}`, {
      method: 'PATCH',
      body: formData
    });
    
    if (response.ok) {
      alert('‚úì Account owner updated successfully');
      loadPortfolioData();
    } else {
      const error = await response.json();
      alert('Error: ' + (error.detail || 'Failed to update'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error updating account owner');
  }
}

function selectAccount(accountName, accountType) {
  // Bank accounts (checking, savings, credit_card) should show transactions
  // Investment accounts should show holdings
  const bankAccountTypes = ['depository', 'credit', 'checking', 'savings', 'credit_card'];
  const isBankAccount = bankAccountTypes.includes(accountType);
  
  if (isBankAccount) {
    // Switch to transactions tab and filter by account
    switchTab('transactions');
    setTimeout(() => {
      const select = document.getElementById('transactionAccountFilter');
      if (select) {
        let options = Array.from(select.options);
        let match = options.find(o => o.value === accountName);
        
        if (match) {
          select.value = accountName;
          applyTransactionFilters();
        }
      }
    }, 100);
  } else {
    // Switch to holdings tab and filter by account
    switchTab('holdings');
    setTimeout(() => {
      const select = document.getElementById('holdingAccountFilter');
      if (select) {
        let options = Array.from(select.options);
        let match = options.find(o => o.value === accountName);
        
        if (match) {
          select.value = accountName;
          applyHoldingFilters();
        }
      }
    }, 100);
  }
}

async function syncAccounts() {
  const syncBtn = event.target;
  syncBtn.disabled = true;
  syncBtn.textContent = 'üîÑ Syncing...';
  
  try {
    // Try Fidelity automated sync first
    const fidelityResponse = await fetch('/portfolio/sync/fidelity', {
      method: 'POST'
    });
    
    if (fidelityResponse.ok) {
      const fidelityData = await fidelityResponse.json();
      
      // Reload data
      loadPortfolioData();
      
      alert(`‚úì Fidelity sync complete!\n${fidelityData.message}`);
      syncBtn.disabled = false;
      syncBtn.textContent = 'üîÑ Sync Now';
      return;
    } else if (fidelityResponse.status === 404) {
      // No credentials, fall back to price sync
      console.log('No Fidelity credentials, falling back to price sync');
    } else {
      // Error with Fidelity sync
      const errorData = await fidelityResponse.json();
      throw new Error(errorData.detail || 'Fidelity sync failed');
    }
    
    // Fall back to price sync
    const priceResponse = await fetch('/portfolio/sync/prices', {
      method: 'POST'
    });
    
    if (!priceResponse.ok) {
      throw new Error('Price sync failed');
    }
    
    const priceData = await priceResponse.json();
    
    // Then sync account balances
    const accountResponse = await fetch('/portfolio/sync/accounts', {
      method: 'POST'
    });
    
    if (!accountResponse.ok) {
      throw new Error('Account sync failed');
    }
    
    const accountData = await accountResponse.json();
    
    // Reload data
    loadPortfolioData();
    
    alert(`‚úì Price sync complete!\n${priceData.message}\n${accountData.message}\n\nTip: Use "Connect Financial Accounts" to add more banks via Plaid.`);
  } catch (error) {
    console.error('Sync error:', error);
    alert('‚úó Sync failed: ' + error.message);
  } finally {
    syncBtn.disabled = false;
    syncBtn.textContent = 'üîÑ Sync Now';
  }
}

// Load on page load
loadPortfolioData();
</script>
{% endraw %}
{% endblock %}
