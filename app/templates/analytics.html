{% extends "base.html" %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h2 style="margin: 0;">HSA Analytics</h2>
  <div style="display: flex; gap: 12px; align-items: center;">
    <label style="font-weight: 600; color: #374151;">Filter by Year:</label>
    <select id="yearFilter" style="padding: 10px 20px; border: 2px solid #d1d5db; border-radius: 8px; font-weight: 600; cursor: pointer; background: white;">
      <option value="all">All Years</option>
    </select>
    <a href="/receipts" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">Back to Receipts</a>
  </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
    <h3 style="margin: 0 0 10px 0; font-size: 1rem; opacity: 0.9;">Total Receipts</h3>
    <p id="totalReceipts" style="font-size: 2.5rem; font-weight: 700; margin: 0;">-</p>
  </div>
  <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white;">
    <h3 style="margin: 0 0 10px 0; font-size: 1rem; opacity: 0.9;">Total Spent</h3>
    <p id="totalSpent" style="font-size: 2.5rem; font-weight: 700; margin: 0;">-</p>
  </div>
  <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; color: white;">
    <h3 style="margin: 0 0 10px 0; font-size: 1rem; opacity: 0.9;">Pending Reimbursement</h3>
    <p id="pendingAmount" style="font-size: 2.5rem; font-weight: 700; margin: 0;">-</p>
  </div>
  <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 12px; color: white;">
    <h3 style="margin: 0 0 10px 0; font-size: 1rem; opacity: 0.9;">Total Reimbursed</h3>
    <p id="totalReimbursed" style="font-size: 2.5rem; font-weight: 700; margin: 0;">-</p>
  </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h3 style="margin: 0 0 20px 0;">Spending by Year</h3>
    <canvas id="yearChart"></canvas>
  </div>
  
  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h3 style="margin: 0 0 20px 0;">Spending by Category</h3>
    <canvas id="categoryChart"></canvas>
  </div>
  
  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h3 style="margin: 0 0 20px 0;">Reimbursement Status by Year</h3>
    <canvas id="reimbursementChart"></canvas>
  </div>
  
  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h3 style="margin: 0 0 20px 0;">HSA Eligible vs Total</h3>
    <canvas id="hsaEligibleChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let analyticsData = null;
let charts = {};

// Fetch analytics data
fetch('/receipts/analytics')
  .then(response => response.json())
  .then(data => {
    analyticsData = data;
    
    // Populate year filter
    const years = Object.keys(data.by_year).sort().reverse();
    const yearFilter = document.getElementById('yearFilter');
    years.forEach(year => {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      yearFilter.appendChild(option);
    });
    
    // Initial render with all years
    renderAnalytics('all');
    
    // Add change listener
    yearFilter.addEventListener('change', (e) => {
      renderAnalytics(e.target.value);
    });
  })
  .catch(error => {
    console.error('Error loading analytics:', error);
    alert('Failed to load analytics data');
  });

function renderAnalytics(selectedYear) {
  if (!analyticsData) return;
  
  let filteredYears = {};
  let filteredCategories = {};
  
  if (selectedYear === 'all') {
    filteredYears = analyticsData.by_year;
    filteredCategories = analyticsData.by_category;
  } else {
    // Filter for specific year
    if (analyticsData.by_year[selectedYear]) {
      filteredYears[selectedYear] = analyticsData.by_year[selectedYear];
    }
    
    // Would need receipt-level filtering for categories by year
    // For now, show all categories when filtering by year
    filteredCategories = analyticsData.by_category;
  }
  
  // Update summary cards
  let totalReceipts = 0;
  let totalSpent = 0;
  let totalPending = 0;
  let totalReimbursed = 0;
  
  Object.values(filteredYears).forEach(year => {
    totalSpent += year.total_spent;
    totalPending += year.pending_reimbursement;
    totalReimbursed += year.reimbursed;
    totalReceipts += year.count;
  });
  
  document.getElementById('totalReceipts').textContent = totalReceipts;
  document.getElementById('totalSpent').textContent = '$' + totalSpent.toFixed(2);
  document.getElementById('pendingAmount').textContent = '$' + totalPending.toFixed(2);
  document.getElementById('totalReimbursed').textContent = '$' + totalReimbursed.toFixed(2);
  
  // Destroy existing charts
  Object.values(charts).forEach(chart => chart.destroy());
  charts = {};
  
  // Spending by Year Chart
  const years = Object.keys(filteredYears).sort();
  const yearSpending = years.map(y => filteredYears[y].total_spent);
  
  charts.year = new Chart(document.getElementById('yearChart'), {
    type: 'bar',
    data: {
      labels: years,
      datasets: [{
        label: 'Total Spent',
        data: yearSpending,
        backgroundColor: 'rgba(102, 126, 234, 0.8)',
        borderColor: 'rgba(102, 126, 234, 1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toFixed(0);
            }
          }
        }
      }
    }
  });
  
  // Category Chart
  const categories = Object.keys(filteredCategories);
  const categoryAmounts = Object.values(filteredCategories);
  
  charts.category = new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: {
      labels: categories,
      datasets: [{
        data: categoryAmounts,
        backgroundColor: [
          'rgba(255, 99, 132, 0.8)',
          'rgba(54, 162, 235, 0.8)',
          'rgba(255, 206, 86, 0.8)',
          'rgba(75, 192, 192, 0.8)',
          'rgba(153, 102, 255, 0.8)',
          'rgba(255, 159, 64, 0.8)'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
  
  // Reimbursement Status Chart
  const reimbursedData = years.map(y => filteredYears[y].reimbursed);
  const pendingData = years.map(y => filteredYears[y].pending_reimbursement);
  const notSubmittedData = years.map(y => filteredYears[y].not_submitted);
  
  charts.reimbursement = new Chart(document.getElementById('reimbursementChart'), {
    type: 'bar',
    data: {
      labels: years,
      datasets: [
        {
          label: 'Reimbursed',
          data: reimbursedData,
          backgroundColor: 'rgba(67, 233, 123, 0.8)'
        },
        {
          label: 'Pending',
          data: pendingData,
          backgroundColor: 'rgba(245, 158, 11, 0.8)'
        },
        {
          label: 'Not Submitted',
          data: notSubmittedData,
          backgroundColor: 'rgba(239, 68, 68, 0.8)'
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toFixed(0);
            }
          }
        }
      }
    }
  });
  
  // HSA Eligible Chart
  const hsaEligibleData = years.map(y => filteredYears[y].hsa_eligible);
  const totalData = years.map(y => filteredYears[y].total_spent);
  
  charts.hsa = new Chart(document.getElementById('hsaEligibleChart'), {
    type: 'line',
    data: {
      labels: years,
      datasets: [
        {
          label: 'HSA Eligible',
          data: hsaEligibleData,
          borderColor: 'rgba(67, 233, 123, 1)',
          backgroundColor: 'rgba(67, 233, 123, 0.2)',
          tension: 0.3,
          fill: true
        },
        {
          label: 'Total Spent',
          data: totalData,
          borderColor: 'rgba(102, 126, 234, 1)',
          backgroundColor: 'rgba(102, 126, 234, 0.2)',
          tension: 0.3,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toFixed(0);
            }
          }
        }
      }
    }
  });
}
</script>
{% endblock %}
