{% extends "base.html" %}
{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
  <h2>Broker Credentials</h2>
  <p style="color: #6b7280; margin-bottom: 30px;">Configure broker credentials for automated account syncing. Passwords are encrypted.</p>

  <!-- Add Fidelity Credentials -->
  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h3>Add Fidelity Credentials</h3>
    <form id="credentialForm" style="display: flex; flex-direction: column; gap: 16px; margin-top: 20px;">
      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 6px;">Fidelity Username</label>
        <input type="text" id="fidelity_username" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" />
      </div>
      
      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 6px;">Fidelity Password</label>
        <input type="password" id="fidelity_password" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" />
      </div>
      
      <button type="submit" style="background: #10b981; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer;">Save Credentials</button>
    </form>
    
    <div id="saveResult" style="margin-top: 16px;"></div>
  </div>

  <!-- Saved Credentials -->
  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h3>Saved Credentials</h3>
    <div id="credentialsList" style="margin-top: 20px;">
      <p style="color: #6b7280;">Loading...</p>
    </div>
  </div>
</div>

<script>
// Load saved credentials
async function loadCredentials() {
  try {
    const response = await fetch('/portfolio/credentials/list');
    const data = await response.json();
    
    if (data.length === 0) {
      document.getElementById('credentialsList').innerHTML = '<p style="color: #6b7280;">No credentials saved yet.</p>';
      return;
    }
    
    const html = data.map(c => `
      <div style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 600;">${c.institution}</div>
          <div style="font-size: 0.875rem; color: #6b7280;">Username: ${c.username}</div>
          <div style="font-size: 0.875rem; color: #6b7280;">Last used: ${c.last_used ? new Date(c.last_used).toLocaleString() : 'Never'}</div>
        </div>
        <button onclick="deleteCredential(${c.id})" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Delete</button>
      </div>
    `).join('');
    
    document.getElementById('credentialsList').innerHTML = html;
  } catch (error) {
    console.error('Error loading credentials:', error);
  }
}

// Save credentials
document.getElementById('credentialForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const username = document.getElementById('fidelity_username').value;
  const password = document.getElementById('fidelity_password').value;
  
  const formData = new FormData();
  formData.append('institution', 'Fidelity');
  formData.append('username', username);
  formData.append('password', password);
  
  try {
    const response = await fetch('/portfolio/credentials/save', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (response.ok) {
      document.getElementById('saveResult').innerHTML = `
        <div style="padding: 12px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; color: #065f46;">
          ✓ ${data.message}
        </div>
      `;
      
      // Clear form
      document.getElementById('fidelity_username').value = '';
      document.getElementById('fidelity_password').value = '';
      
      // Reload credentials list
      loadCredentials();
    } else {
      document.getElementById('saveResult').innerHTML = `
        <div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
          ✗ Error: ${data.detail || 'Failed to save credentials'}
        </div>
      `;
    }
  } catch (error) {
    document.getElementById('saveResult').innerHTML = `
      <div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
        ✗ Error: ${error.message}
      </div>
    `;
  }
});

// Delete credential
async function deleteCredential(id) {
  if (!confirm('Are you sure you want to delete these credentials?')) {
    return;
  }
  
  try {
    const response = await fetch(`/portfolio/credentials/${id}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      loadCredentials();
    } else {
      alert('Error deleting credentials');
    }
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

// Load on page load
loadCredentials();
</script>
{% endblock %}
