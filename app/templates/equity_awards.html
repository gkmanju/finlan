{% extends "base.html" %}

{% block title %}Equity Awards - FinLAN{% endblock %}

{% block content %}
<div class="container">
    <h2>Equity Awards Dashboard</h2>
    
    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
        <div style="background: #10b981; color: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; opacity: 0.9;">RSU Sellable Value</div>
            <div style="font-size: 24px; font-weight: bold;" id="totalRsuValue">$0</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;" id="sellableRsuQtyLabel">0 shares</div>
        </div>
        <div style="background: #8b5cf6; color: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; opacity: 0.9;">RSU Unvested Value</div>
            <div style="font-size: 24px; font-weight: bold;" id="unvestedRsuValue">$0</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;" id="unvestedRsuQtyLabel">0 shares</div>
        </div>
        <div style="background: #0f766e; color: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; opacity: 0.9;">Total RSU Value</div>
            <div style="font-size: 24px; font-weight: bold;" id="totalRsuAllValue">$0</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Sellable + Unvested</div>
        </div>
        <div style="background: #f59e0b; color: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; opacity: 0.9;">Total ESPP Value</div>
            <div style="font-size: 24px; font-weight: bold;" id="totalEsppValue">$0</div>
        </div>
        <div style="background: #06b6d4; color: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; opacity: 0.9;">Total ESPP Gain/Loss</div>
            <div style="font-size: 24px; font-weight: bold;" id="totalEsppGainLoss">$0</div>
        </div>
        <div style="background: #1e293b; color: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; opacity: 0.9;">Total Equity Awards</div>
            <div style="font-size: 24px; font-weight: bold;" id="totalEquityValue">$0</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">RSU + ESPP</div>
        </div>
        <div style="background: #15803d; color: white; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; opacity: 0.9;">Total Sellable Equity</div>
            <div style="font-size: 24px; font-weight: bold;" id="totalSellableEquityValue">$0</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Vested RSU + ESPP</div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div style="border-bottom: 2px solid #e5e7eb; margin: 30px 0 20px 0;">
        <button class="tab-btn active" onclick="switchTab('rsu')">RSU Grants</button>
        <button class="tab-btn" onclick="switchTab('espp')">ESPP Purchases</button>
    </div>

    <!-- RSU Grants Table -->
    <div id="rsuTab" class="tab-content">
        <h3>RSU Grants</h3>
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Grant Number</th>
                        <th>Grant Date</th>
                        <th>Granted</th>
                        <th>Vested</th>
                        <th>Unvested</th>
                        <th>Withheld</th>
                        <th>Sellable</th>
                        <th>Progress</th>
                        <th>Current Price</th>
                        <th>Market Value <span style="font-size:11px;background:#10b981;color:white;padding:2px 5px;border-radius:3px;">LIVE</span></th>
                    </tr>
                </thead>
                <tbody id="rsuTableBody">
                    <tr><td colspan="10" style="text-align: center; padding: 40px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ESPP Table -->
    <div id="esppTab" class="tab-content" style="display: none;">
        <h3>ESPP Purchases</h3>
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Purchase Date</th>
                        <th>Purchase Price</th>
                        <th>Current Price</th>
                        <th>Purchased Qty</th>
                        <th>Sellable Qty</th>
                        <th>Gain/Loss <span style="font-size:11px;background:#10b981;color:white;padding:2px 5px;border-radius:3px;">LIVE</span></th>
                        <th>Market Value <span style="font-size:11px;background:#10b981;color:white;padding:2px 5px;border-radius:3px;">LIVE</span></th>
                    </tr>
                </thead>
                <tbody id="esppTableBody">
                    <tr><td colspan="8" style="text-align: center; padding: 40px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.tab-btn {
    background: none;
    border: none;
    padding: 12px 24px;
    cursor: pointer;
    font-size: 16px;
    color: #6b7280;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
}

.tab-btn:hover {
    color: #111827;
}

.tab-btn.active {
    color: #10b981;
    border-bottom-color: #10b981;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

.data-table thead {
    background: #f9fafb;
}

.data-table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
}

.data-table td {
    padding: 12px;
    border-bottom: 1px solid #f3f4f6;
}

.data-table tbody tr:hover {
    background: #f9fafb;
}

.vesting-progress {
    display: flex;
    align-items: center;
    gap: 8px;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #059669);
    transition: width 0.3s;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.badge-success {
    background: #d1fae5;
    color: #065f46;
}

.badge-warning {
    background: #fef3c7;
    color: #92400e;
}
</style>

<script>
let rsuGrants = [];
let esppGrants = [];

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
    
    if (tab === 'rsu') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('rsuTab').style.display = 'block';
    } else {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('esppTab').style.display = 'block';
    }
}

function formatCurrency(value) {
    if (!value && value !== 0) return '-';
    return '$' + parseFloat(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function formatNumber(value, decimals = 0) {
    if (!value && value !== 0) return '-';
    return parseFloat(value).toLocaleString('en-US', {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'});
}

async function loadRSUGrants() {
    try {
        const response = await fetch('/portfolio/rsu/grants');
        rsuGrants = await response.json();
        renderRSUTable();
        updateSummary();
    } catch (error) {
        console.error('Error loading RSU grants:', error);
        document.getElementById('rsuTableBody').innerHTML = '<tr><td colspan="10" style="text-align: center; color: red;">Error loading data</td></tr>';
    }
}

async function loadESPPGrants() {
    try {
        const response = await fetch('/portfolio/espp/grants');
        esppGrants = await response.json();
        renderESPPTable();
        updateSummary();
    } catch (error) {
        console.error('Error loading ESPP grants:', error);
        document.getElementById('esppTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Error loading data</td></tr>';
    }
}

function renderRSUTable() {
    const tbody = document.getElementById('rsuTableBody');
    
    if (rsuGrants.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #9ca3af;">No RSU grants found</td></tr>';
        return;
    }
    
    tbody.innerHTML = rsuGrants.map(grant => `
        <tr>
            <td><strong>${grant.symbol}</strong></td>
            <td><span style="font-family: monospace; font-size: 13px;">${grant.grant_number || '-'}</span></td>
            <td>${formatDate(grant.grant_date)}</td>
            <td>${formatNumber(grant.granted_qty)}</td>
            <td>${formatNumber(grant.vested_qty)}</td>
            <td>${formatNumber(grant.unvested_qty)}</td>
            <td>${formatNumber(grant.withheld_qty)}</td>
            <td><strong>${formatNumber(grant.sellable_qty)}</strong></td>
            <td>
                <div class="vesting-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${grant.vesting_progress}%"></div>
                    </div>
                    <span style="font-size: 13px; color: #6b7280; min-width: 40px;">${grant.vesting_progress}%</span>
                </div>
            </td>
            <td>${grant.live_price ? formatCurrency(grant.live_price) : '-'}</td>
            <td><strong>${formatCurrency(grant.est_market_value)}</strong></td>
        </tr>
    `).join('');
}

function renderESPPTable() {
    const tbody = document.getElementById('esppTableBody');
    
    if (esppGrants.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #9ca3af;">No ESPP purchases found</td></tr>';
        return;
    }
    
    tbody.innerHTML = esppGrants.map(grant => {
        const gainLoss = grant.expected_gain_loss || 0;
        const gainLossColor = gainLoss >= 0 ? '#10b981' : '#ef4444';
        const gainLossPrefix = gainLoss > 0 ? '+' : '';
        
        return `
            <tr>
                <td><strong>${grant.symbol}</strong></td>
                <td>${formatDate(grant.purchase_date)}</td>
                <td>${formatCurrency(grant.purchase_price)}</td>
                <td>${grant.live_price ? formatCurrency(grant.live_price) : '-'}</td>
                <td>${formatNumber(grant.purchased_qty, 3)}</td>
                <td><strong>${formatNumber(grant.sellable_qty, 3)}</strong></td>
                <td style="color: ${gainLossColor}; font-weight: 600;">${gainLossPrefix}${formatCurrency(gainLoss)}</td>
                <td><strong>${formatCurrency(grant.est_market_value)}</strong></td>
            </tr>
        `;
    }).join('');
}

function updateSummary() {
    // RSU totals
    const totalSellableRsuValue = rsuGrants.reduce((sum, g) => sum + (g.est_market_value || 0), 0);
    const totalUnvestedRsuValue = rsuGrants.reduce((sum, g) => sum + (g.unvested_market_value || 0), 0);
    const totalSellableRsu = rsuGrants.reduce((sum, g) => sum + (g.sellable_qty || 0), 0);
    const totalUnvestedRsu = rsuGrants.reduce((sum, g) => sum + (g.unvested_qty || 0), 0);
    
    document.getElementById('totalRsuValue').textContent = formatCurrency(totalSellableRsuValue);
    document.getElementById('sellableRsuQtyLabel').textContent = formatNumber(totalSellableRsu) + ' shares';
    document.getElementById('unvestedRsuValue').textContent = formatCurrency(totalUnvestedRsuValue);
    document.getElementById('unvestedRsuQtyLabel').textContent = formatNumber(totalUnvestedRsu) + ' shares';
    document.getElementById('totalRsuAllValue').textContent = formatCurrency(totalSellableRsuValue + totalUnvestedRsuValue);
    
    // ESPP totals
    const totalEsppValue = esppGrants.reduce((sum, g) => sum + (g.est_market_value || 0), 0);
    const totalEsppGainLoss = esppGrants.reduce((sum, g) => sum + (g.expected_gain_loss || 0), 0);
    const gainLossEl = document.getElementById('totalEsppGainLoss');
    gainLossEl.textContent = (totalEsppGainLoss >= 0 ? '+' : '') + formatCurrency(totalEsppGainLoss);
    gainLossEl.style.color = totalEsppGainLoss >= 0 ? '#d1fae5' : '#fee2e2';
    document.getElementById('totalEsppValue').textContent = formatCurrency(totalEsppValue);
    
    // Total Equity Awards = RSU (sellable + unvested) + ESPP
    const totalEquity = totalSellableRsuValue + totalUnvestedRsuValue + totalEsppValue;
    document.getElementById('totalEquityValue').textContent = formatCurrency(totalEquity);
    
    // Total Sellable Equity = Vested RSU + ESPP
    document.getElementById('totalSellableEquityValue').textContent = formatCurrency(totalSellableRsuValue + totalEsppValue);
}

// Load data on page load
loadRSUGrants();
loadESPPGrants();
</script>
{% endblock %}
