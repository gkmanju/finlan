{% extends "base.html" %}
{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h2 style="margin: 0;">Connect Financial Accounts</h2>
    <a href="/portfolio" style="background: #6b7280; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none;">â† Back to Portfolio</a>
  </div>

  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; color: white; margin-bottom: 30px;">
    <h3 style="margin: 0 0 15px 0; font-size: 1.5rem;">ğŸ”’ Secure Bank Connection</h3>
    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">Connect your bank and investment accounts automatically using Plaid. Your credentials are encrypted and never stored on our servers. Plaid uses bank-level 256-bit encryption.</p>
  </div>

  <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h3 style="margin: 0 0 20px 0;">Add New Connection</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
      <div style="border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ¦</div>
        <h4 style="margin: 0 0 10px 0;">Bank Accounts</h4>
        <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Connect checking, savings, and credit cards for automatic transaction sync.</p>
      </div>
      <div style="border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“ˆ</div>
        <h4 style="margin: 0 0 10px 0;">Investment Accounts</h4>
        <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Connect brokerage, 401(k), and IRA accounts for portfolio tracking.</p>
      </div>
    </div>
    <button id="linkButton" onclick="openPlaidLink()" style="background: #10b981; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; width: 100%;">
      ğŸ”— Connect Account with Plaid
    </button>
  </div>

  <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0;">Connected Accounts</h3>
      <button onclick="refreshConnections()" style="background: #6366f1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">ğŸ”„ Refresh</button>
    </div>
    <div id="connectedItems">
      <p style="color: #6b7280; text-align: center; padding: 40px;">No accounts connected yet. Click "Connect Account" above to get started.</p>
    </div>
  </div>
</div>

<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
let linkHandler = null;

{% if oauth_return %}
// Returning from OAuth redirect â€” re-initialize Link with receivedRedirectUri to complete flow
window.addEventListener('load', async () => {
  try {
    const response = await fetch('/portfolio/plaid/create-link-token', { method: 'POST' });
    if (!response.ok) { const e = await response.json(); alert('OAuth resume error: ' + (e.detail || 'Failed')); return; }
    const data = await response.json();
    const handler = Plaid.create({
      token: data.link_token,
      receivedRedirectUri: window.location.href,
      onSuccess: async (public_token, metadata) => {
        try {
          const formData = new FormData();
          formData.append('public_token', public_token);
          formData.append('institution_name', metadata.institution.name);
          formData.append('institution_id', metadata.institution.institution_id);
          const res = await fetch('/portfolio/plaid/exchange-token', { method: 'POST', body: formData });
          if (res.ok) {
            alert('âœ“ Account connected successfully! Syncing data...');
            setTimeout(() => { window.location.href = '/portfolio/connect'; }, 1500);
          } else {
            const err = await res.json();
            alert('Error connecting account: ' + (err.detail || JSON.stringify(err)));
          }
        } catch (e) { alert('Error: ' + e.message); }
      },
      onExit: (err) => {
        if (err) alert('Plaid error: ' + (err.error_message || err.error_code || 'Unknown error'));
        else window.location.href = '/portfolio/connect';
      }
    });
    handler.open();
  } catch (e) { alert('Error resuming OAuth: ' + e.message); }
});
{% endif %}

async function openPlaidLink() {
  try {
    // Get link token from backend
    const response = await fetch('/portfolio/plaid/create-link-token', {
      method: 'POST'
    });
    
    if (!response.ok) {
      const error = await response.json();
      alert('Error: ' + (error.detail || 'Failed to initialize Plaid'));
      return;
    }
    
    const data = await response.json();
    
    // Initialize Plaid Link
    linkHandler = Plaid.create({
      token: data.link_token,
      onSuccess: async (public_token, metadata) => {
        try {
          console.log('Plaid Link success:', metadata);
          console.log('Public token received, exchanging...');
          
          // Exchange public token for access token
          const formData = new FormData();
          formData.append('public_token', public_token);
          formData.append('institution_name', metadata.institution.name);
          formData.append('institution_id', metadata.institution.institution_id);
          
          const exchangeResponse = await fetch('/portfolio/plaid/exchange-token', {
            method: 'POST',
            body: formData
          });
          
          console.log('Exchange response status:', exchangeResponse.status);
          
          if (exchangeResponse.ok) {
            const result = await exchangeResponse.json();
            console.log('Exchange successful:', result);
            alert('âœ“ Account connected successfully! Syncing data...');
            setTimeout(() => {
              loadConnectedItems();
              window.location.href = '/portfolio';
            }, 2000);
          } else {
            const error = await exchangeResponse.json();
            console.error('Exchange error response:', error);
            alert('Error connecting account: ' + (error.detail || JSON.stringify(error)));
          }
        } catch (error) {
          console.error('Exception in onSuccess:', error);
          alert('Error: ' + error.message);
        }
      },
      onExit: (err, metadata) => {
        if (err) {
          console.error('Plaid Link error:', err);
          alert('Plaid error: ' + (err.error_message || err.error_code || 'Unknown error'));
        }
      }
    });
    
    linkHandler.open();
  } catch (error) {
    console.error('Error:', error);
    alert('Error initializing Plaid: ' + error.message);
  }
}

async function loadConnectedItems() {
  try {
    const response = await fetch('/portfolio/plaid/items');
    const items = await response.json();
    
    if (items.length === 0) {
      document.getElementById('connectedItems').innerHTML = '<p style="color: #6b7280; text-align: center; padding: 40px;">No accounts connected yet. Click "Connect Account" above to get started.</p>';
      return;
    }
    
    const html = items.map(item => `
      <div style="border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 5px;">ğŸ¦ ${item.institution_name}</div>
            <div style="color: #6b7280; font-size: 0.9rem;">
              Last synced: ${item.last_synced ? new Date(item.last_synced).toLocaleString() : 'Never'}
            </div>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="syncItem(${item.id})" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Sync Now</button>
            <button onclick="updatePermissions(${item.id})" style="background: #6366f1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;" title="Re-link to add investment holdings access (required for Vanguard, Fidelity, etc.)">ğŸ”„ Add Holdings Access</button>
            <button onclick="deleteItem(${item.id})" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Disconnect</button>
          </div>
        </div>
      </div>
    `).join('');
    
    document.getElementById('connectedItems').innerHTML = html;
  } catch (error) {
    console.error('Error loading connected items:', error);
  }
}

async function syncItem(itemId) {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Syncing...';
  
  try {
    const response = await fetch(`/portfolio/plaid/sync/${itemId}`, {
      method: 'POST'
    });
    
    if (response.ok) {
      const result = await response.json();
      const holdingsNote = result.holdings === 0
        ? '\nâš ï¸ No holdings synced. For investment accounts, click "Add Holdings Access" to re-link and grant investment permissions.'
        : '';
      alert(`âœ“ Sync complete!\nAccounts: ${result.accounts}\nTransactions: ${result.transactions}\nHoldings: ${result.holdings}${holdingsNote}`);
      loadConnectedItems();
    } else {
      const error = await response.json();
      alert('Sync error: ' + error.detail);
    }
  } catch (error) {
    alert('Sync error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Sync Now';
  }
}

async function updatePermissions(itemId) {
  try {
    // Get update link token
    const response = await fetch(`/portfolio/plaid/update-link-token/${itemId}`, {
      method: 'POST'
    });
    
    if (!response.ok) {
      const error = await response.json();
      alert('Error: ' + error.detail);
      return;
    }
    
    const data = await response.json();
    
    // Open Plaid Link in update mode
    const linkHandler = Plaid.create({
      token: data.link_token,
      onSuccess: async (public_token, metadata) => {
        alert('âœ“ Permissions updated! Now sync to fetch account owner names.');
        loadConnectedItems();
      },
      onExit: (err, metadata) => {
        if (err) {
          console.error('Plaid Link error:', err);
          alert('Update error: ' + (err.error_message || err.error_code || 'Unknown error'));
        }
      }
    });
    
    linkHandler.open();
  } catch (error) {
    console.error('Error:', error);
    alert('Error updating permissions: ' + error.message);
  }
}

async function deleteItem(itemId) {
  if (!confirm('Are you sure you want to disconnect this account?')) {
    return;
  }
  
  try {
    const response = await fetch(`/portfolio/plaid/items/${itemId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      alert('âœ“ Account disconnected');
      loadConnectedItems();
    } else {
      alert('Error disconnecting account');
    }
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

function refreshConnections() {
  loadConnectedItems();
}

// Load on page load
loadConnectedItems();
</script>
{% endblock %}
